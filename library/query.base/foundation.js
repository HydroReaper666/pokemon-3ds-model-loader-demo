!function(){var t=Array.prototype.slice,e=window.navigator.userAgent.toLowerCase(),n=-1!==e.indexOf("msie")||-1!==e.indexOf("trident"),r=function(){},o=null,i=function(){if(null!==o)return o;if(!global.$||!global.$["!space"])return!1;var t=global.$["!space"]("query").accelerated;return t?o=t():void 0};r.prototype.valueSet=function(){var t=p.create.list(this.domain,[]);return this.forEach(function(e){t.include(e)}),t},r.prototype.array=function(){return t.call(this,0)},r.prototype.first=function(){return this.length>0?this[0]:null},r.prototype.last=function(){return this.length>0?this[this.length-1]:null},r.prototype.lifted=function(){return this.operateOn(p.create.list(this.domain,[]),function(t,e){if(p.is.nil(e))t.push(e);else if(p.is(e,String)||p.is(e,Function))t.push(e);else if(p.is(e,Node))t.push(e);else if(p.is(e.length,Number))for(var n=0;n<e.length;)t.push(e[n]),++n;else t.push(e)})},r.prototype.isEmpty=function(){return 0===this.length},r.prototype.clone=function(){return p.create.list(this.domain,t.call(this,0))},r.prototype.forEach=function(t){for(var e=0;e<this.length;)t(this[e],e,this),++e;return this},r.prototype.map=function(t){return this.operateOn(p.create.list(this.domain,[]),function(e,n,r,o){e[r]=t(n,r,o)})},r.prototype.fold=function(t,e){var n=t;return this.forEach(function(t,r,o){n=e(n,t,r,o)}),n},r.prototype.operateOn=function(t,e){return this.fold(t,function(t,n,r,o){return e(t,n,r,o),t})},r.prototype.filter=function(t){return this.find(t).map(function(t){return this[t]}.bind(this))},r.prototype.find=function(t){return t||(t=function(t,e,n){return!0}),p.is(t,RegExp)?t=function(t){return function(e){return!!p.equals(t,e)||!!p.is(e,String)&&void t.test(e)}}(t):p.is(t,Function)||(t=function(t){return function(e){return p.equals(t,e)}}(t)),this.operateOn(p.create.list(this.domain,[]),function(e,n,r,o){t(n,r,o)&&e.push(r)})},r.prototype.slice=function(e,n){return p.is.nil(e)&&(e=0),p.is.nil(n)&&(n=this.length),e<0&&(e+=this.length)<0&&(e=0),e>this.length&&(e=this.length),n<=0&&(n+=this.length)<e&&(n=e),p.create.list(this.domain,t.call(this,e,n))},r.prototype.splice=function(t,e){return p.create.list(this.domain,Array.prototype.splice.apply(this,arguments))},r.prototype.push=function(){return Array.prototype.push.apply(this,arguments),this},r.prototype.pop=function(){return Array.prototype.pop.apply(this,arguments)},r.prototype.unshift=function(){return Array.prototype.unshift.apply(this,arguments),this},r.prototype.shift=function(){return Array.prototype.shift.apply(this,arguments)},r.prototype.include=function(){for(var t=0;t<arguments.length;)0===this.find(arguments[t]).length&&this.push(arguments[t]),++t;return this},r.prototype.exclude=function(){var e=this.map(function(t,e,n){return{index:e,item:t}}),n=arguments;1!==arguments.length||p.is.nil(arguments[0])||p.is(arguments[0],String)||!p.is(arguments[0].length,Number)||(n=t.call(arguments[0])).push(arguments[0]);for(var r=0;r<n.length;){for(var o=this.find(n[r]),i=o.length;i>0;)--i,e.splice(o[i],1),this.splice(o[i],1);++r}return e.sort(function(t,e){return t.index<e.index?-1:t.index>e.index?1:0}).map(function(t){return t.item})},r.prototype.shuffle=function(){var t=this.map(function(t){return Math.random()});return this.sort(function(e,n,r,o){return t[r]<t[o]?-1:t[r]>t[o]?1:0})},r.prototype.sort=function(t){t||(t=function(t,e,n,r){return(""+t).localeCompare(""+e)});var e=this;return this.map(function(t,e){return{item:t,index:e}}).array().sort(function(e,n){return t(e.item,n.item,e.index,n.index)}).forEach(function(t,n){e[n]=t.item}),this},r.prototype.property=function(){return 0===arguments.length||1===arguments.length&&p.is(arguments[0],String)?this.properties.apply(this,arguments)[0]:this.properties.apply(this,arguments)},r.prototype.properties=function(){if(0===arguments.length||1===arguments.length&&p.is(arguments[0],String)){var t=null;return 1===arguments.length&&(t=arguments[0]),this.map(function(e){return null!==t?e[t]:e})}var e={};return 2===arguments.length?e[arguments[0]]=arguments[1]:e=arguments[0],this.forEach(function(t){for(var n in e)t[n]=e[n]})};var s=["common","empty"],a={empty:{tests:[],initializers:[],prototype:{}},common:{tests:[function(t){return!0}],initializers:[function(t){p.query.list(t).operateOn(this,function(t,e){t.push(e)})}],prototype:r.prototype}},p=function(){var t=null;if(arguments.length>1){t=[];for(e=0;e<arguments.length;)t[e]=arguments[e],++e}else if(1===arguments.length)if(null===arguments[0]||void 0===arguments[0])t=[arguments[0]];else if("string"==typeof arguments[0]||arguments[0]instanceof String)t=[arguments[0]];else if("function"==typeof arguments[0]||arguments[0]instanceof Function)t=[arguments[0]];else if(arguments[0]instanceof Node||n&&arguments[0].nodeType)t=[arguments[0]];else if(!("number"==typeof arguments[0].length||arguments[0].length instanceof Number)||"string"==typeof arguments[0]||arguments[0]instanceof String||"function"==typeof arguments[0]||arguments[0]instanceof Function||arguments[0]instanceof Node||n&&arguments[0].nodeType)t=[arguments[0]];else{t=[];for(var e=0;e<arguments[0].length;)t[e]=arguments[0][e],++e}else t=[];return 1===t.length&&t[0]instanceof r?t[0].clone():p.query.list(s).operateOn({passed:!1,query:p.query.empty()},function(e,n){!e.passed&&p.query.list(a[n].tests).fold(!1,function(e,n){return e||n(t)})&&(e.passed=!0,e.query=p.query.list(a[n].initializers).operateOn(p.create.list(n,[]),function(e,n){n.call(e,t)}))}).query};p.Query=r,p.create=function(e){var r=null,o=arguments.length;if(o>2)r=t.call(arguments,1);else if(2===o){var s=arguments[1],a=i();if(null!==s&&void 0!==s)if(Array.isArray(s))switch(u=s.length){case 0:r=[];break;case 1:r=[s[0]];break;case 2:r=[s[0],s[1]];break;case 3:r=[s[0],s[1],s[2]];break;case 4:r=[s[0],s[1],s[2],s[3]];break;case 5:r=[s[0],s[1],s[2],s[3],s[4]];break;default:r=s.slice(0)}else if("string"==typeof s||!a&&s instanceof String)r=[s];else if("function"==typeof s||!a&&s instanceof Function)r=[s];else if(s.nodeType&&(a||n||s instanceof Node))r=[s];else if(isFinite(s.length)){var u=s.length;switch(u){case 0:r=[];break;case 1:r=[s[0]];break;case 2:r=[s[0],s[1]];break;case 3:r=[s[0],s[1],s[2]];break;case 4:r=[s[0],s[1],s[2],s[3]];break;case 5:r=[s[0],s[1],s[2],s[3],s[4]];break;default:r=t.call(s,0)}}else r=[s];else r=[s]}else r=[];return e||(e="common"),p.create.list(e,r)},p.create.list=function(t,e){var i=null;if(a.hasOwnProperty(t)&&(i=a[t].prototype),i||(i=r.prototype),o)e.__proto__=i;else if(Object.setPrototypeOf)Object.setPrototypeOf(e,i);else try{Object.defineProperty(e,"__proto__",{enumerable:!1,value:i})}catch(t){e.__proto__=i}return n&&Object.keys(i).forEach(function(t){e[t]&&!r.prototype[t]||(e[t]=i[t])}),e},p.upgrade=function(t){if(t){if(t.hasOwnProperty("domain")&&t.domain||(t.domain="common"),t.hasOwnProperty("prototype")&&t.prototype||(t.prototype="common"),("string"==typeof t.prototype||t.prototype instanceof String)&&(t.prototype=a[t.prototype].prototype),t.prototype||(t.prototype=r.prototype),t.addons||(t.addons={}),a.hasOwnProperty(t.domain)||(a[t.domain]={tests:[],initializers:[],prototype:Object.create(t.prototype)},a[t.domain].prototype.constructor=r,a[t.domain].prototype.domain=t.domain,s.unshift(t.domain)),t.hasOwnProperty("test")&&t.test&&a[t.domain].tests.push(t.test),t.hasOwnProperty("initializer")&&t.initializer&&a[t.domain].initializers.push(t.initializer),t.hasOwnProperty("prototype")&&t.prototype)for(var e in t.prototype)a[t.domain].prototype[e]||(a[t.domain].prototype[e]=t.prototype[e]);for(var e in t.addons)a[t.domain].prototype[e]&&(t.addons[e].super=a[t.domain].prototype[e]),a[t.domain].prototype[e]=t.addons[e];n&&Object.keys(t.prototype).forEach(function(e){a[t.domain].prototype[e]||(a[t.domain].prototype[e]=t.prototype[e])})}},p.query=function(e,n,r,o,i){var s=arguments.length;if(!(s<6)){var a=t.call(arguments,0);return a.unshift("common"),p.create.apply(p,a)}switch(s){case 0:return p.create.list("common",[]);case 1:return p.create("common",e);case 2:return p.create.list("common",[e,n]);case 3:return p.create.list("common",[e,n,r]);case 4:return p.create.list("common",[e,n,r,o]);case 5:return p.create.list("common",[e,n,r,o,i]);default:throw new Error("Impossible")}},p.query.list=function(t){return p.create.list("common",t)},p.query.empty=function(t){return p.create.list("common",[])},p.equals=function(t,e){return t instanceof RegExp&&e instanceof RegExp?t.source===e.source&&t.global===e.global&&t.ignoreCase===e.ignoreCase&&t.multiline===e.multiline:p.simplify(t)===p.simplify(e)};var u={};Array.prototype.forEach.call(document.querySelectorAll("meta"),function(t){var e=t.getAttribute("name");if(e){u.hasOwnProperty(e)||(u[e]=[]);var n={};Array.prototype.forEach.call(t.attributes,function(t){if(!t.namespaceURI&&"name"!==t.nodeName){var e=t.nodeName.replace(/\-[a-z]/g,function(t){return t.slice(1).toUpperCase()});n[e]=t.nodeValue}}),u[e].push(n)}}),p.meta=function(t,e){var n={};return u.hasOwnProperty(t)&&u[t].forEach(function(t){Object.keys(t).forEach(function(e){n[e]=t[e]})}),e&&e.constructor==Boolean?n:(e||(e="content"),n[e])},p.metas=function(t,e){return e&&e.constructor==Boolean?u[t]:(e||(e="content"),u.hasOwnProperty(t)?u[t].filter(function(t){return t.hasOwnProperty(e)}).map(function(t){return t[e]}):[])};var c={};p["!space"]=function(t,e){if(!e){if(c.hasOwnProperty(t))return c[t]();throw new Error("Space "+t+" not found")}c[t]=e},p["!space"]("query",function(){return p}),require("module").getter("$",function(t,e){var n=e.trim().substring(0,512),r=Object.keys(c).filter(function(t){return-1!==n.indexOf('"use '+t+'";')})[0];return r&&c.hasOwnProperty(r)?p["!space"](r):p["!space"](l)});var l="query";p["!use"]=function(t){if(!c.hasOwnProperty(t))throw new Error("No space with name "+t+" has been set up");l=t};try{Object.defineProperty(p,"domains",{enumerable:!1,get:function(){return t.call(s,0)},set:function(t){s=p.query.list(s.clone()).operateOn(p.query.list(t).valueSet(),function(t,e){t.include(e)}).filter(function(t){return p.query.list(s).find(t).length>0}).array()}})}catch(t){p.domains=s}try{Object.defineProperty(global,"$",{enumerable:!0,get:function(){return c[l]()}})}catch(t){global.$=p}module.exports=p}();