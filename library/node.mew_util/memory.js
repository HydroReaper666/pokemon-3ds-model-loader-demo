var path=require("path");if("js"!==process.arch)var url=require("url"),rdb=require("./memory/rdb.js");var kv=require("./memory/kv.js"),memories=new Map,nextMemoryID=1,recalledMemories=new WeakRefMap,strongMemories=new Set,recallMemory=function(e,r){-1===e.indexOf(":")&&(e=e+"://localhost/memory/temp?id="+nextMemoryID,++nextMemoryID);var o=null;if(recalledMemories.has(e)&&(o=recalledMemories.get(e)),!o){if(url)a=url.parse(e);else var a={protocol:e.split(":")[0]+":"};if("file:"===a.protocol){var t=path.extname(a.pathname);if(!memories.has(t))throw new Error("Memory not found "+e);o=memories.get(t)(e,r)}else{if(!a.protocol||!memories.has(a.protocol))throw new Error("Memory not found "+e);o=memories.get(a.protocol)(e,r)}if(!o)throw new Error("Memory not found "+e);Object.defineProperty(o,"uri",{enumerable:!0,value:e}),recalledMemories.set(e,o)}return r&&r.strong&&strongMemories.add(o),o},handleMemory=function(e,r,o){memories.set(e,o),r&&memories.set(r,o)};handleMemory("map:",".map",function(e){return new kv.Map}),handleMemory("weak-map:",".weak-map",function(e){return new kv.WeakMap}),handleMemory("weak-ref-map:",".weak-ref-map",function(e){return new kv.WeakRefMap}),handleMemory("cache-pool:",".cache-pool",function(e,r){if(url){var o=url.parse(e,!0).query.timeout;!o&&r&&(o=r.timeout);var a=null;r&&(a=r.delegate)}else o=void 0,a=null;return new kv.CachePool(o,a)}),handleMemory("json:",".json",function(e){throw new Error("Not supported memory "+e)}),handleMemory("dict:",".dict",function(e){throw new Error("Not supported memory "+e)}),"js"!==process.arch&&handleMemory("sqlite:",".sqlite",function(e){var r=url.parse(e,!0);return"sqlite:"===r.protocol&&(r.protocol="file:",r.query.mode="memory",delete r.search,e=url.format(r)),new rdb.SQLite(e)}),module.exports={recallMemory:recallMemory,handleMemory:handleMemory,Map:kv.Map,WeakMap:kv.WeakMap,WeakRefMap:kv.WeakRefMap,CachePool:kv.CachePool},"js"!==process.arch&&(module.exports.sql=rdb.sql,module.exports.SQLite=rdb.SQLite);