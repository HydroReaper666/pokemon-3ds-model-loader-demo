var async=require("./async.js"),foundation=require("./foundation.js"),template=require("./template.js"),uuid=require("./uuid.js"),templateCaches={},Rule=function(e,t){if(this.id=uuid.createUUID(),foundation.isKindOf(e,Function))this.type="function",this.function=e;else if(foundation.isKindOf(e,String)||"template"===t)this.type="template",foundation.isKindOf(e,String)?(templateCaches.hasOwnProperty(e)||(templateCaches[e]=template.compile(e,t)),this.template=templateCaches[e],this.presetData=t?t.presetData:null):(templateCaches.hasOwnProperty(e.template.template)||(templateCaches[e.template.template]=e.template),this.template=e.template,this.presetData=e.presetData);else if(foundation.isKindOf(e,Boolean))this.type=e.toString();else{if("is"!==t)throw new Error("Invalid rule type");this.type="is",this.object=e}};Rule.prototype.type="true",Rule.prototype.test=function(e,t){switch(this.type){case"function":return async.ensure(this.function(e,t));case"true":return async.resolve(!0);case"false":return async.resolve(!1);case"is":return async.resolve(this.object===e);case"template":return async.resolve(!!template.execute(this.template,foundation.simpleMerge(this.presetData,e),t));default:return async.reject(new Error("Invalid rule type"))}},Rule.prototype.serialize=function(e){var t={type:this.type};switch(this.type){case"template":t.template=this.template,t.presetData=this.presetData;break;case"is":t.object=this.object;break;case"true":case"false":break;default:throw new Error("Invalid rule type")}return e?JSON.stringify(t):t},Rule.parse=function(e){switch(foundation.isKindOf(e,String)&&(e=JSON.parse(e)),e.type){case"template":return new Rule(e,"template");case"true":return new Rule(!0);case"false":return new Rule(!1);case"is":return new Rule(e.object,"is");default:throw new Error("Unknown rule type")}},Rule.ensure=function(e,t){return foundation.isKindOf(e,Rule)?e:new Rule(e,t)};var Ruler=function(e){this.rules=[],this.rulesShouldAllPassed=e};Ruler.prototype.test=function(e,t){if(this.rulesShouldAllPassed){r=!0;return async.all(this.rules,function(s){r?s.test(e,t).then(function(e){e||(r=!1),this.next()}).pipe(this):this.next()}).then(function(){this.next(r)})}var r=!1;return async.all(this.rules,function(s){r?this.next():s.test(e,t).then(function(e){e&&(r=!0),this.next()}).pipe(this)}).then(function(){this.next(r)})},Ruler.prototype.addRule=function(e,t){var r=Rule.ensure(e,t);return-1===this.rules.indexOf(r)&&this.rules.push(r),r},Ruler.prototype.removeRule=function(e){if(foundation.isKindOf(e,String)&&(e=this.rules.filter(function(t){return t.id===e})[0]),e){var t=this.rules.indexOf(e);-1!==t&&this.rules.splice(t,1)}},Ruler.prototype.reset=function(){this.rules=[]},Ruler.prototype.serialize=function(){return JSON.stringify({rules:this.rules.map(function(e){return e.serialize(!1)}),rulesShouldAllPassed:this.rulesShouldAllPassed})},Ruler.prototype.merge=function(e){e.rules.forEach(function(e){return this.addRule(e)})},Ruler.parse=function(e){var t=JSON.parse(e),r=new Ruler(t.rulesShouldAllPassed);return t.rules.forEach(function(e){r.addRule(Rule.parse(e))}),r},Ruler.Rule=Rule,module.exports=Ruler;