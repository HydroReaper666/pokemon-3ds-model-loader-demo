var finalTemplate=function(e,t,n){if(n||(n="text/plain"),n.constructor==String&&(n={parser:n}),n.parser||(n.parser="text/plain"),t){if(!n.parametersMutable){var r={};for(var a in t)r[a]=t[a];t=r}}else t={};return finalTemplate.parsers[n.parser]?finalTemplate.parsers[n.parser](e,t,n):null};finalTemplate.operators={},finalTemplate.operatorQueue=[["right","!","~"],["left","*","/","%"],["left","+","-"],["left","<<",">>"],["left","<",">","<=",">="],["left","==","!="],["left","&"],["left","^"],["left","|"],["left","&&"],["left","||"],["right",";"]],finalTemplate.functors={},finalTemplate.parsers={},finalTemplate.lexer={},finalTemplate.Operator=function(e,t,n,r,a){return this.call=function(o,l,i,u,c){var s=[].slice.call(arguments,4),f={};if(5===arguments.length)for(var p in c)f[p]=c[p];else for(var p in t)f[p]=t[p];if(f.$n)for(var h=1;h<=f.$n;)delete f["$"+h],++h;return r.forEach(function(e,t){f[e]=s[t]}),f.$0=this,f.$n=s.length,f.$a=s,5===arguments.length?f["^"]=c:f["^"]=t,s.forEach(function(e,t){f["$"+(t+1)]=e}),finalTemplate.run(e,a,f,n)},this},finalTemplate.lexer.stringify=function(e){"blk"!=e.type&&((e=[e]).type="blk",e.operator="",e.index=e[0].index);var t={"(":")","[":"]","{":"}"}[e.operator];t||(t=e.operator);var n=[];return n.push(e.operator),e.forEach(function(e){if(e)switch(e.type){case"qot":n.push('"'+e.content.replace(/\\/gim,"\\\\").replace(/\n/gim,"\\n").replace(/"/gim,'\\"')+'"');break;case"num":case"sym":case"opr":n.push(e.content);break;case"fnc":case"opc":n.push(e.content),n.push("(");var t=[];e.arguments.forEach(function(e){t.push(finalTemplate.lexer.stringify(e))}),n.push(t.join(",")),n.push(")");break;case"reg":n.push("#"+e.content.source.replace(/#/gim,"\\#")+"#");break;case"blk":n.push(finalTemplate.lexer.stringify(e))}else n.push("")}),n.push(t),n.join("")},finalTemplate.lexer.getSymbol=function(e,t){for(;t<e.length&&-1!=[9,10,13,32].indexOf(e.charCodeAt(t));)++t;if(!(t<e.length))return{type:"eot",content:null,index:e.length};var n=e.charCodeAt(t);switch(n){case 34:case 39:for(var r=[],a=0,o=t+1;o<e.length&&(a=e.charCodeAt(o))!=n;)if(92==a){switch(l=e.charCodeAt(o+1)){case 110:r.push("\n");break;case 92:r.push("\\");break;case 34:r.push('"');break;case 39:r.push("'");break;default:return{type:"err",description:"Invalid escaped character",content:null,index:o+1}}o+=2}else r.push(e.charAt(o)),++o;return o<e.length?{type:"qot",content:r.join(""),index:t,next:o+1}:{type:"err",description:"Quotation not be terminated",content:null,index:e.length};case 35:for(var r=[],a=0,o=t+1;o<e.length&&35!=(a=e.charCodeAt(o));)if(92==a){var l=e.charCodeAt(o+1);35==l?r.push("#"):r.push(String.fromCharCode(92,l)),o+=2}else r.push(e.charAt(o)),++o;return o<e.length?{type:"reg",content:new RegExp(r.join(""),"gm"),index:t,next:o+1}:{type:"err",description:"Regular expression not be terminated",content:null,index:e.length};case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:for(var i=!1,a=0,o=t;o<e.length&&-1!=[48,49,50,51,52,53,54,55,56,57,46].indexOf(a=e.charCodeAt(o));){if(46==a){if(i)return{type:"err",description:"Two dots have been found in number",content:null,index:o};i=!0}++o}var u=e.substring(t,o);return i?{type:"num",content:parseFloat(u),index:t,next:o}:{type:"num",content:parseInt(u),index:t,next:o};case 46:case 43:case 45:case 61:case 42:case 47:case 38:case 33:case 94:case 37:case 126:case 60:case 62:case 44:case 63:case 58:case 59:case 124:case 40:case 41:case 91:case 93:case 123:case 125:var c=["&&","||",">=","<=","!=","==",">>","<<"];return t+1<e.length&&-1!=c.indexOf(e.charAt(t)+e.charAt(t+1))?{type:"opr",content:e.charAt(t)+e.charAt(t+1),index:t,next:t+2}:{type:"opr",content:e.charAt(t),index:t,next:t+1};default:for(var a=0,o=t;o<e.length&&-1==[9,10,13,32,34,39,35,46,43,45,61,42,47,38,33,94,37,126,60,62,44,63,58,59,124,40,41,91,93,123,125].indexOf(a=e.charCodeAt(o));)++o;return{type:"sym",content:u=e.substring(t,o),index:t,next:o}}},finalTemplate.lexer.convertCharacter=function(e){for(var t=[],n=0;n<e.length;){var r=finalTemplate.lexer.getSymbol(e,n);switch(r.type){case"err":var a=r.description+". ";throw a+="Code: "+e.substring(Math.max(r.index-10,0),Math.min(r.index+10,e.length)),new Error(a);case"eot":n=e.length;break;case"num":case"opr":case"sym":case"qot":case"reg":default:t.push(r),n=r.next}}return t},finalTemplate.lexer.convertBracket=function(e,t){var n=[];n.type="blk",n.operator="",n.symbol=t[0];var r=n;return t.forEach(function(n){if("opr"==n.type)switch(n.content){case"(":case"[":case"{":var a=[];a.superqueue=r,a.type="blk",a.operator=n.content,a.symbol=n,a.index=n.index,r.push(a),r=a;break;case")":case"]":case"}":if(!r.superqueue){o=r.symbol;r.length>0&&"blk"==(o=r[r.length-1]).type&&(o=o.symbol),o||(o=t[t.length-1]);l=e.substring(Math.max(o.index-10,0),Math.min(o.index+10,e.length));throw new Error("No close brackets found. Code: "+l)}if(""==r.operator||"("!=r.operator&&")"==n.content||"["!=r.operator&&"]"==n.content||"{"!=r.operator&&"}"==n.content){var o=r.symbol;r.length>0&&"blk"==(o=r[r.length-1]).type&&(o=o.symbol),o||(o=t[t.length-1]);var l=e.substring(Math.max(o.index-10,0),Math.min(o.index+10,e.length));throw new Error("Brackets not matched. Code: "+l)}r=r.superqueue;break;default:r.push(n)}else r.push(n)}),n},finalTemplate.lexer.convertSugar=function(e,t){var n=[];n.symbol=t.symbol,n.type=t.type,n.operator=t.operator;var r=0;return t.forEach(function(a,o){if(!(r>o))switch(a.type){case"opr":if("."==a.content){for(l=[];n.length>0&&"opr"!=n[n.length-1].type;)l.unshift(n.pop());f=t[o+1];if(n.push({type:"ops",content:".",index:a.index,next:a.next}),(p=[]).symbol=a,p.type="blk",p.operator="(",l.forEach(function(e){p.push(e)}),p.push({type:"opr",content:",",index:a.index,next:a.next}),"sym"!=f.type){m=e.substring(Math.max(f.index-10,0),Math.min(f.index+10,e.length));throw new Error("Invalid usage of dot on syntax. Code: "+m)}p.push({type:"qot",content:f.content,index:f.index,next:f.next}),n.push(p),r=o+2}else";"==a.content?o<t.length-1&&n.push(a):n.push(a);break;case"blk":if("["==a.operator){for(var l=[];n.length>0&&"opr"!=n[n.length-1].type;)l.unshift(n.pop());f=finalTemplate.lexer.convertSugar(e,a);n.push({type:"ops",content:l.length>0?".":"#",index:a.index,next:a.next}),(p=[]).symbol=a,p.type="blk",p.operator="(",l.length>0&&(l.forEach(function(e){p.push(e)}),p.push({type:"opr",content:",",index:a.index,next:a.next})),f.forEach(function(e){p.push(e)}),n.push(p)}else if("{"==a.operator){var i=a.filter(function(e){return"opr"==e.type&&":"==e.content}).length>0,u=a.filter(function(e){return"opr"==e.type&&"?"==e.content}).length>0;if(i&&u){m=e.substring(Math.max(a.index-10,0),Math.min(a.index+10,e.length));throw new Error("Undetermined definition of object or switch. Code: "+m)}if(a.length>0&&!i&&!u){f=finalTemplate.lexer.convertSugar(e,a);if(n.push({type:"ops",content:"$",index:a.index,next:a.next}),(p=[]).symbol=a,p.type="blk",p.operator="(",p.index=a.index,1==f.length&&"opr"==f[0].type){c=function(e,t){return{type:e,content:t,index:f[0].index,next:f[0].next}};switch(f[0].content){case"-":p.push(c("sym","if")),(s=[]).symbol=f[0],s.type="blk",s.operator="(",s.push(c("sym","$n")),s.push(c("opr","==")),s.push(c("num",1)),s.push(c("opr",",")),s.push(c("opr",f[0].content)),s.push(c("sym","$1")),s.push(c("opr",",")),s.push(c("sym","$1")),s.push(c("opr",f[0].content)),s.push(c("sym","$2")),p.push(s);break;case"~":case"!":p.push(c("opr",f[0].content)),p.push(c("sym","$1"));break;default:p.push(c("sym","$1")),p.push(c("opr",f[0].content)),p.push(c("sym","$2"))}}else f.forEach(function(e){p.push(e)});n.push(p)}else if(2==a.length&&u&&"sym"==a[0].type){var c=function(e,t){return{type:e,content:t,index:a[0].index,next:a[0].next}};n.push({type:"ops",content:"$",index:a.index,next:a.next}),(p=[]).symbol=a,p.type="blk",p.operator="(",p.index=a.index,p.push(c("sym","execute"));var s=[];s.symbol=a,s.type="blk",s.operator="(",s.index=a.index,s.push(c("qot",a[0].content)),s.push(c("opr",",")),s.push(c("sym","$a")),p.push(s),n.push(p)}else{var f=finalTemplate.lexer.convertSugar(e,a);n.push({type:"ops",content:i?"@":"?",index:a.index,next:a.next});var p=[];p.symbol=a,p.type="blk",p.operator="(";var h=i?":":"?";if(f.forEach(function(t){if("opr"!=t.type||","!=t.content&&":"!=t.content&&"?"!=t.content)p.push(t);else{if(t.content!=h){var n=e.substring(Math.max(t.index-10,0),Math.min(t.index+10,e.length));throw new Error("Invalid inline object syntax. Code: "+n)}p.push({type:"opr",content:",",index:t.index,next:t.next}),h=","==t.content?i?":":"?":","}}),"opr"==f[f.length-1].type&&("?"==f[f.length-1].content||":"==f[f.length-1].content)){var m=e.substring(Math.max(f[f.length-1].index-10,0),Math.min(f[f.length-1].index+10,e.length));throw new Error("Invalid inline object syntax. Code: "+m)}n.push(p)}}else n.push(finalTemplate.lexer.convertSugar(e,a));break;case"num":case"sym":case"qot":case"reg":default:n.push(a)}}),n},finalTemplate.lexer.convertCall=function(e,t){var n=[];n.symbol=t.symbol,n.type=t.type,n.operator=t.operator;return t.forEach(function(t,r){if(!(0>r))switch(t.type){case"blk":if("("==t.operator)if(n.length>0&&("sym"==n[n.length-1].type||"ops"==n[n.length-1].type)){var a=n.pop(),o=[],l=[];l.type="blk",l.operator="",l.symbol=t,o.push(l),t.forEach(function(n){if("opr"==n.type&&","==n.content){if(0==o[o.length-1].length){var r=e.substring(Math.max(n.index-10,0),Math.min(n.index+10,e.length));throw new Error("No argument found. Code: "+r)}var a=[];a.type="blk",a.operator="",a.symbol=t,o.push(a)}else o[o.length-1].push(n)});for(var i=0;i<o.length;)o[i]=finalTemplate.lexer.convertCall(e,o[i]),++i;1==o.length&&0==o[0].length&&(o=[]),n.push({type:"sym"==a.type?"fnc":"opc",content:a.content,arguments:o,symbol:a,index:a.index,next:a.next})}else n.push(finalTemplate.lexer.convertCall(e,t));else n.push(finalTemplate.lexer.convertCall(e,t));break;case"opr":case"ops":case"num":case"sym":case"qot":case"reg":default:n.push(t)}}),n},finalTemplate.lexer.convertOperator=function(e,t){if(t.operatorNo)return t;var n=t.slice(0);n.symbol=t.symbol,n.type=t.type,n.operator=t.operator,n.operatorNo=!0;for(var r=0;r<finalTemplate.operatorQueue.length;){for(var a="left"==finalTemplate.operatorQueue[r][0],o=a?0:n.length-1;o<n.length&&o>=0;){if("opr"==n[o].type&&finalTemplate.operatorQueue[r].indexOf(n[o].content)>0)if("!"==n[o].content||"~"==n[o].content||0==o&&"-"==n[o].content){if(o+1>=n.length){s=e.substring(Math.max(n[o].index-10,0),Math.min(n[o].index+10,e.length));throw new Error('No operatee found for operator "'+n[o].content+'". Code: '+s)}u=[];(c=[]).type="blk",c.operator="",c.symbol=n[o],u.push(c),c.push(n[o+1]);for(var l=o,i=1;"opr"==n[l+i].type;){if(l+i>=n.length){s=e.substring(Math.max(n[l+i].index-10,0),Math.min(n[l+i].index+10,e.length));throw new Error('No operatee found for operator "'+n[l+i].content+'". Code: '+s)}c.push(n[l+i+1]),a?(++o,++i):(--o,--i)}n.splice(l,1+i,{type:"opc",content:n[l].content,arguments:u,symbol:n[l],index:n[l].index,next:n[l].next})}else{var u=[];if(o+1>=n.length||o<1){s=e.substring(Math.max(n[o].index-10,0),Math.min(n[o].index+10,e.length));throw new Error('No operatee found for operator "'+n[o].content+'". Code: '+s)}var c=[];c.type="blk",c.operator="",c.symbol=n[o],u.push(c),c.push(n[o-1]),(c=[]).type="blk",c.operator="",c.symbol=n[o],u.push(c),c.push(n[o+1]);for(var l=o,i=1;"opr"==n[l+i].type;){if(l+i>=n.length){var s=e.substring(Math.max(n[l+i].index-10,0),Math.min(n[l+i].index+10,e.length));throw new Error('No operatee found for operator "'+n[l+i].content+'". Code: '+s)}c.push(n[l+i+1]),a?++o:--o,++i}n.splice(l-1,i+2,{type:"opc",content:n[l].content,arguments:u,symbol:n[l],index:n[l].index,next:n[l].next}),a&&--o}a?++o:--o}++r}var f=[];return f.symbol=t.symbol,f.type=t.type,f.operator=t.operator,f.operatorNo=!0,n.forEach(function(t){switch(t.type){case"blk":f.push(finalTemplate.lexer.convertOperator(e,t));break;case"fnc":case"opc":var n=[];t.arguments.forEach(function(t){n.push(finalTemplate.lexer.convertOperator(e,t))}),f.push({type:t.type,content:t.content,arguments:n,symbol:t.symbol,index:t.index,next:t.next});break;case"opr":case"ops":case"num":case"sym":case"qot":case"reg":default:f.push(t)}}),f},finalTemplate.lexer.convertQueue=function(e,t){if(!t||0==t.length)return null;if(t.length>1){r=e.substring(Math.max(t[0].index-10,0),Math.min(t[0].index+10,e.length));throw new Error("Queue could not be simplfied to pure function calls. Code: "+r)}switch(t[0].type){case"fnc":case"opc":var n=[];return t[0].arguments.forEach(function(t){n.push(finalTemplate.lexer.convertQueue(e,t))}),{type:t[0].type,content:t[0].content,arguments:n,index:t[0].index};case"blk":return finalTemplate.lexer.convertQueue(e,t[0]);case"sym":case"qot":case"reg":case"num":return t[0];case"opr":case"ops":default:var r=e.substring(Math.max(t[0].index-10,0),Math.min(t[0].index+10,e.length));throw new Error("Queue could not be simplfied to pure function calls. Code: "+r)}},finalTemplate.run=function(e,t,n,r){switch(r||(r={}),t.type){case"fnc":case"opc":var a=null;if("fnc"==t.type?(r.functors&&(a=r.functors[t.content]),a||(a=finalTemplate.functors[t.content])):a=finalTemplate.operators[t.content],a!==Function&&a!==eval||(a=null),!a){i=e.substring(Math.max(t.index-10,0),Math.min(t.index+10,e.length));throw new Error("Function or operator definition not found: "+i)}var o=[];t.arguments.forEach(function(t){var a=null,l=!1;o.push(function(){return l||(a=finalTemplate.run(e,t,n,r),l=!0),a})}),a.lazy||(o=o.map(function(e){return e()}));var l=[e,t,n,r];o.forEach(function(e){l.push(e)});return a.apply(null,l);case"sym":switch(t.content){case"true":return!0;case"false":return!1;case"null":return null;case"undefined":return;case"nan":return NaN;case"infinity":return 1/0;case"$d":return n;default:return n[t.content]}case"num":case"qot":case"reg":return t.content;case"opr":case"ops":default:var i=e.content.substring(Math.max(t.index-10,0),Math.min(t.index+10,e.length));throw new Error("Invalid code: "+i)}},finalTemplate.execute=function(e,t,n){if(t){if(!n.parametersMutable){var r={};for(var a in t)r[a]=t[a];t=r}}else t={};n||(n={});var o=finalTemplate.lexer.convertCharacter(e);if(0==o.length)return null;var l=finalTemplate.lexer.convertBracket(e,o),l=finalTemplate.lexer.convertSugar(e,l),l=finalTemplate.lexer.convertCall(e,l),l=finalTemplate.lexer.convertOperator(e,l),i=finalTemplate.lexer.convertQueue(e,l);return finalTemplate.run(e,i,t,n)},finalTemplate.compile=function(e,t){t||(t={});var n=finalTemplate.lexer.convertCharacter(e);if(0==n.length)return null;var r=finalTemplate.lexer.convertBracket(e,n),r=finalTemplate.lexer.convertSugar(e,r),r=finalTemplate.lexer.convertCall(e,r),r=finalTemplate.lexer.convertOperator(e,r),a=finalTemplate.lexer.convertQueue(e,r);return a.template=e,a},finalTemplate.operators["."]=function(e,t,n,r,a,o){if(null===a||void 0===a)return null;var l=a[o];return r.functionAvailable?l!==Function&&l!==eval||(l=null):l&&l.constructor==Function&&(l=null),l},finalTemplate.operators["*"]=function(e,t,n,r,a,o){return a*o},finalTemplate.operators["/"]=function(e,t,n,r,a,o){return a/o},finalTemplate.operators["%"]=function(e,t,n,r,a,o){return a%o},finalTemplate.operators["+"]=function(e,t,n,r,a,o){return a+o},finalTemplate.operators["-"]=function(e,t,n,r,a,o){return 5==arguments.length?-a:a-o},finalTemplate.operators["!"]=function(e,t,n,r,a){return!a},finalTemplate.operators["~"]=function(e,t,n,r,a){return~a},finalTemplate.operators["&"]=function(e,t,n,r,a,o){return a()&o()},finalTemplate.operators["|"]=function(e,t,n,r,a,o){return a()|o()},finalTemplate.operators["^"]=function(e,t,n,r,a,o){return a()^o()},finalTemplate.operators["&&"]=function(e,t,n,r,a,o){return a()&&o()},finalTemplate.operators["||"]=function(e,t,n,r,a,o){return a()||o()},finalTemplate.operators[">"]=function(e,t,n,r,a,o){return a>o},finalTemplate.operators["<"]=function(e,t,n,r,a,o){return a<o},finalTemplate.operators[">="]=function(e,t,n,r,a,o){return a>=o},finalTemplate.operators["<="]=function(e,t,n,r,a,o){return a<=o},finalTemplate.operators[">>"]=function(e,t,n,r,a,o){return a>>o},finalTemplate.operators["<<"]=function(e,t,n,r,a,o){return a<<o},finalTemplate.operators["=="]=function(e,t,n,r,a,o){var l=null===a||void 0===a,i=null===o||void 0===o;return!(!l||!i)||a===o},finalTemplate.operators["!="]=function(e,t,n,r,a,o){return a!==o},finalTemplate.operators["#"]=function(e,t,n,r){return[].slice.call(arguments,4)},finalTemplate.operators["@"]=function(e,t,n,r){var a=[].slice.call(arguments,4);if(a.length%2==1){var o=e.substring(Math.max(t.arguments[t.arguments.length-1].index-10,0),Math.min(t.arguments[t.arguments.length-1].index+10,e.length));throw new Error("Invalid inline object syntax. Code: "+o)}for(var l={},i=0;i<a.length;)l[a[i]]=a[i+1],i+=2;return l},finalTemplate.operators.$=function(e,t,n,r){var a=t.arguments.slice(0,t.arguments.length-1).map(function(t){if("sym"!=t.type){var n=e.substring(Math.max(t.index-10,0),Math.min(t.index+10,e.length));throw new Error("Invalid argument definition. Code: "+n)}return t.content}),o=t.arguments[t.arguments.length-1];return new finalTemplate.Operator(e,n,r,a,o)},finalTemplate.operators[";"]=function(e,t,n,r,a,o){var l=a();return n.$x=l,o()},finalTemplate.operators["?"]=function(e,t,n,r){for(var a=n.$x,o=[].slice.call(arguments,4),l=0;l<o.length;){if(l==o.length-1)return o[l]();if(o[l]()===a)return o[l+1]();l+=2}return null},finalTemplate.operators["&"].lazy=!0,finalTemplate.operators["|"].lazy=!0,finalTemplate.operators["^"].lazy=!0,finalTemplate.operators["&&"].lazy=!0,finalTemplate.operators["||"].lazy=!0,finalTemplate.operators.$.lazy=!0,finalTemplate.operators[";"].lazy=!0,finalTemplate.operators["?"].lazy=!0,finalTemplate.functors.call=function(e,t,n,r,a){return finalTemplate.functors.execute(e,t,n,r,a,[].slice.call(arguments,5))},finalTemplate.functors.execute=function(e,t,n,r,a,arguments){if(!a)return null;arguments||(arguments=[]);var o=arguments.slice();return o.unshift(r),o.unshift(n),o.unshift(t),o.unshift(e),a.constructor==finalTemplate.Operator?a.call.apply(a,o):a.constructor==String&&finalTemplate.functors[a]?finalTemplate.functors[a].apply(this,o):null},finalTemplate.functors.echo=function(e,t,n,r,a){return r&&r.echo?r.echo(a):global.$&&global.$.dump?global.$.dump(a):console.log(a),a},finalTemplate.functors.if=function(e,t,n,r,a,o,l){return a()?o():l()},finalTemplate.functors.default=function(e,t,n,r,a,o){return a()?a():o()},finalTemplate.functors.round=function(e,t,n,r,a){return Math.round(a)},finalTemplate.functors.floor=function(e,t,n,r,a){return Math.floor(a)},finalTemplate.functors.ceil=function(e,t,n,r,a){return Math.ceil(a)},finalTemplate.functors.min=function(e,t,n,r){var a=[].slice.call(arguments,4);return Math.min.apply(Math,a)},finalTemplate.functors.max=function(e,t,n,r){var a=[].slice.call(arguments,4);return Math.max.apply(Math,a)},finalTemplate.functors.trim=function(e,t,n,r,a){return a.trim()},finalTemplate.functors.split=function(e,t,n,r,a,o){return a.split(o)},finalTemplate.functors.join=function(e,t,n,r,a,o){return a.join(o)},finalTemplate.functors.slice=function(e,t,n,r,a,o,l){return a.slice(o,l)},finalTemplate.functors.search=function(e,t,n,r,a,o,l){return a.indexOf(o,l)},finalTemplate.functors.string=function(e,t,n,r){var a=[].slice.call(arguments,4);return String.fromCharCode.apply(String,a)},finalTemplate.functors.text=function(e,t,n,r,a,o){return a.toString(o)},finalTemplate.functors.code=function(e,t,n,r,a){for(var o=[],l=0;l<a.length;)o.push(a.charCodeAt(l)),++l;return o},finalTemplate.functors.lowerCase=function(e,t,n,r,a){return a.toLocaleLowerCase()},finalTemplate.functors.upperCase=function(e,t,n,r,a){return a.toLocaleUpperCase()},finalTemplate.functors.date=function(e,t,n,r,a,o,l,i,u,c,s){if(4==arguments.length)return new Date;if(5==arguments.length)return/^(\-?)[0-9]+(\.[0-9]+)?$/.test(a)?new Date(1e3*a):new Date(a);if(7==arguments.length)return(f=new Date(a,o-1,l)).setFullYear(a),f;if(10==arguments.length)return(f=new Date(a,o-1,l,i,u,c)).setFullYear(a),f;if(11==arguments.length){var f=new Date(a,o-1,l,i,u,c,s);return f.setFullYear(a),f}return null},finalTemplate.functors.timeunit=function(e,t,n,r,a,o){switch(o){case"year":return a.getFullYear();case"month":return a.getMonth()+1;case"date":return a.getDate();case"day":return a.getDay();case"hour":return a.getHours();case"minute":return a.getMinutes();case"second":return a.getSeconds();case"millisecond":return a.getMilliseconds();case"timestamp":return a.getTime()/1e3;default:return null}},finalTemplate.functors.replace=function(e,t,n,r,a,o,l,i){return a.replace(o,l,i)},finalTemplate.functors.match=function(e,t,n,r,a,o){return o.test(a)},finalTemplate.functors.format=function(e,t,n,r,e,a){for(var o=function(e,t){for(e+="";e.length<t;)e="0"+e;return e},l=[],i=0;i<e.length;)switch(e.charAt(i)){case"Y":"Y"==e.charAt(i+1)?"Y"==e.charAt(i+2)&&"Y"==e.charAt(i+3)?(l.push(o(a.getFullYear(),4)),i+=4):(l.push(o(a.getFullYear()%100,2)),i+=2):(l.push(a.getFullYear()+""),++i);break;case"M":"M"==e.charAt(i+1)?(l.push(o(a.getMonth()+1,2)),i+=2):(l.push(a.getMonth()+1+""),++i);break;case"D":"D"==e.charAt(i+1)?(l.push(o(a.getDate(),2)),i+=2):(l.push(a.getDate()+""),++i);break;case"h":"h"==e.charAt(i+1)?(l.push(o(a.getHours(),2)),i+=2):(l.push(a.getHours()+""),++i);break;case"m":"m"==e.charAt(i+1)?(l.push(o(a.getMinutes(),2)),i+=2):(l.push(a.getMinutes()+""),++i);break;case"s":"s"==e.charAt(i+1)?(l.push(o(a.getSeconds(),2)),i+=2):(l.push(a.getSeconds()+""),++i);break;case"S":"S"==e.charAt(i+1)&&"S"==e.charAt(i+2)?(l.push(o(a.getMilliseconds(),3)),i+=3):(l.push(a.getMilliseconds()+""),++i);break;case'"':case"'":for(var u=1;e.charAt(i+u)!=e.charAt(i)&&i+u<e.length;)"\\"==e.charAt(i+u)?(l.push(e.charAt(i+u+1)),u+=2):(l.push(e.charAt(i+u)),++u);i+=u+1;break;default:l.push(e.charAt(i)),++i}return l.join("")},finalTemplate.functors.parse=function(e,t,n,r,a,o){return-1!=a.indexOf(".")?parseFloat(a,o):parseInt(a,o)},finalTemplate.functors.fixed=function(e,t,n,r,a,o){return a.toFixed(o)},finalTemplate.functors.precision=function(e,t,n,r,a,o){return a.toPrecision(o)},finalTemplate.functors.filter=function(e,t,n,r,a,o){return a.filter(function(a,l,i){return o.call(e,t,n,r,a,l,i)})},finalTemplate.functors.map=function(e,t,n,r,a,o){return a?a.map(function(a,l,i){return o.call(e,t,n,r,a,l,i)}):[]},finalTemplate.functors.count=function(e,t,n,r,a,o){return o?a.filter(function(a,l,i){return o.call(e,t,n,r,a,l,i)}).length:a.length},finalTemplate.functors.sort=function(e,t,n,r,a,o){return a=a.slice(0),o?a.sort(function(a,l){return o.call(e,t,n,r,a,l)}):a.sort()},finalTemplate.functors.fold=function(e,t,n,r,a,o,l){return a.forEach(function(a,i,u){o=l.call(e,t,n,r,o,a,i,u)}),o},finalTemplate.functors.log=function(e,t,n,r,a,o){return 5==arguments.length?Math.log(a):Math.log(a)/Math.log(o)},finalTemplate.functors.power=function(e,t,n,r,a,o){return 5==arguments.length?Math.pow(Math.E,arguments[4]):Math.pow(a,o)},finalTemplate.functors.sqrt=function(e,t,n,r,a){return Math.sqrt(a)},finalTemplate.functors.cbrt=function(e,t,n,r,a){return Math.cbrt(a)},finalTemplate.functors.sin=function(e,t,n,r,a){return Math.sin(a)},finalTemplate.functors.cos=function(e,t,n,r,a){return Math.cos(a)},finalTemplate.functors.tan=function(e,t,n,r,a){return Math.tan(a)},finalTemplate.functors.asin=function(e,t,n,r,a){return Math.asin(a)},finalTemplate.functors.acos=function(e,t,n,r,a){return Math.acos(a)},finalTemplate.functors.atan=function(e,t,n,r,a){return Math.atan(a)},finalTemplate.functors.angle=function(e,t,n,r,a,o){return Math.atan2(o,a)},finalTemplate.functors.sinh=function(e,t,n,r,a){return Math.sinh(a)},finalTemplate.functors.cosh=function(e,t,n,r,a){return Math.cosh(a)},finalTemplate.functors.tanh=function(e,t,n,r,a){return Math.tanh(a)},finalTemplate.functors.asinh=function(e,t,n,r,a){return Math.asinh(a)},finalTemplate.functors.acosh=function(e,t,n,r,a){return Math.acosh(a)},finalTemplate.functors.atanh=function(e,t,n,r,a){return Math.atanh(a)},finalTemplate.functors.e=function(e,t,n,r){return Math.E},finalTemplate.functors.pi=function(e,t,n,r){return Math.PI},finalTemplate.functors.seq=function(e,t,n,r,a,o,l){arguments.length<7&&(l=a<o?1:-1);var i=[],u=a;do{i.push(u),u+=l}while(a<o?u<=o:u>=o);return i},finalTemplate.functors.fill=function(e,t,n,r,a,o){for(var l=[],i=0;i<o;)a.constructor==finalTemplate.Operator?l.push(a.call(e,t,n,r)):l.push(a),++i;return l},finalTemplate.functors.push=function(e,t,n,r,a){return(a=a.slice(0)).push.apply(a,[].slice.call(arguments,5)),a},finalTemplate.functors.pop=function(e,t,n,r,a){return(a=a.slice(0)).pop(),a},finalTemplate.functors.unshift=function(e,t,n,r,a){return(a=a.slice(0)).unshift.apply(a,[].slice.call(arguments,5)),a},finalTemplate.functors.shift=function(e,t,n,r,a){return(a=a.slice(0)).shift(),a},finalTemplate.functors.index=function(e,t,n,r,a,o,l){if(l){for(i=a.length;i>0;)if(--i,o instanceof finalTemplate.Operator){if(o.call(e,t,n,r,i,a[i],a))return i}else if(o===a[i])return i}else for(var i=0;i<a.length;){if(o instanceof finalTemplate.Operator){if(o.call(e,t,n,r,i,a[i],a))return i}else if(o===a[i])return i;++i}return-1},finalTemplate.functors.contain=function(e,t,n,r,a,o){if(!a)return!1;for(var l=0;l<a.length;){if(o instanceof finalTemplate.Operator){if(o.call(e,t,n,r,l,a[l],a))return!0}else if(o===a[l])return!0;++l}return!1},finalTemplate.functors.splice=function(e,t,n,r,a){return(a=a.slice(0)).splice.apply(a,[].slice.call(arguments,5)),a},finalTemplate.functors.include=function(e,t,n,r,a,o){var a=a.slice(0);return o.forEach(function(e){-1==a.indexOf(e)&&a.push(e)}),a},finalTemplate.functors.exclude=function(e,t,n,r,a,o){var a=a.slice(0);return o.forEach(function(e){var t=a.indexOf(e);-1!=t&&a.splice(t,1)}),a},finalTemplate.functors.concat=function(e,t,n,r,a,o){var a=a.slice(0);return o.forEach(function(e){a.push(e)}),a},finalTemplate.functors.keys=function(e,t,n,r,a){var o=[];for(var l in a)o.push(l);return o},finalTemplate.functors.values=function(e,t,n,r,a){var o=[];for(var l in a)-1==a.indexOf(a[l])&&o.push(a[l]);return o},finalTemplate.functors.each=function(e,t,n,r,a,o){var l={};for(var i in a)l[i]=o.call(e,t,n,r,i,a[i],a);return l},finalTemplate.functors.mix=function(e,t,n,r,a,o){var l={};for(var i in a)l[i]=a[i];for(var i in o)l[i]=o[i];return l},finalTemplate.functors.template=function(e,t,n,r,e,a){var o={};for(var l in r)o[l]=r;return o.parser="text/plain",finalTemplate(e,a,o)},finalTemplate.functors.reverse=function(e,t,n,r,a){return a.slice(0).reverse()},finalTemplate.functors.define=function(e,t,n,r,a,o){if(!/^[a-zA-Z\$_][a-zA-Z0-9\$_]*$/g.test(a))throw new Error("Invalid variant name: "+a);for(n.hasOwnProperty(a)||(n[a]=o);n["^"];)(n=n["^"])[a]=o;return n[a]},finalTemplate.functors.random=function(e,t,n,r){return Math.random()},finalTemplate.functors.sandbox=function(e,t,n,r){var a={};for(var o in n)a[o]=n[o];delete a["^"],finalTemplate.run(e,t.arguments[0],a,r).call(e,t,a,r)},finalTemplate.functors.isNil=function(e,t,n,r,a){return null===a||void 0===a},finalTemplate.functors.isNumber=function(e,t,n,r,a){return null!==a&&void 0!==a&&a.constructor===Number},finalTemplate.functors.isString=function(e,t,n,r,a){return null!==a&&void 0!==a&&a.constructor===String},finalTemplate.functors.isList=function(e,t,n,r,a){return null!==a&&void 0!==a&&(a.constructor===Array||a instanceof Array)},finalTemplate.functors.isDate=function(e,t,n,r,a){return null!==a&&void 0!==a&&a.constructor===Date},finalTemplate.functors.isRegex=function(e,t,n,r,a){return null!==a&&void 0!==a&&a.constructor===RegExp},finalTemplate.functors.isObject=function(e,t,n,r,a){return null!==a&&void 0!==a},finalTemplate.functors.typeOf=function(e,t,n,r,a){return null===a||void 0===a?"null":a.constructor===Number?"number":a.constructor===String?"string":a.constructor===Date?"date":a.constructor===RegExp?"regex":a.constructor===Array||a instanceof Array?"list":"object"},finalTemplate.functors.via=function(e,t,n,r,a,o){var l=a;return o.split(".").filter(function(e){return e.length>0}).forEach(function(e){null!==l&&void 0!=l&&(l=l[e])}),l},finalTemplate.functors.data=function(e,t,n,r){return n},finalTemplate.functors.if.lazy=!0,finalTemplate.functors.default.lazy=!0,finalTemplate.functors.sandbox.lazy=!0,finalTemplate.parsers["text/plain"]=function(e,t,n,r){if(e.constructor===String){for(var a=[],o=[],l=0;l<e.length;)if("$"==e.charAt(l)&&l+1<e.length&&"{"==e.charAt(l+1)){for(var i=[],u=(l+=2,1);u>0&&l<e.length;){var c=finalTemplate.lexer.getSymbol(e,l);"opr"==c.type&&("{"==c.content?++u:"}"==c.content&&--u),i.push(c),l=c.next}if(u>0){var s=e.substring(Math.max(l-10,0),Math.min(l+10,e.length));throw new Error("Bracket not terminated. Code: "+s)}if(i.pop(),i.length>0){var f=finalTemplate.lexer.convertBracket(e,i),f=finalTemplate.lexer.convertSugar(e,f),f=finalTemplate.lexer.convertCall(e,f),f=finalTemplate.lexer.convertOperator(e,f),p=finalTemplate.lexer.convertQueue(e,f);o.push({type:"call",call:p,template:e});var h=finalTemplate.run(e,p,t,n);a.push(h)}}else o.push({type:"text",text:e.charAt(l)}),a.push(e.charAt(l)),++l;if(r){var m=[];o.forEach(function(e){"text"===e.type?m.length>0&&"text"===m[m.length-1].type?m[m.length-1].text.push(e.text):m.push({type:"text",text:[e.text]}):m.push(e)}),m.forEach(function(e){"text"===e.type&&(e.text=e.text.join(""))}),r(m)}return a.join("")}a=[];return e.forEach(function(e){if("text"===e.type)a.push(e.text);else{if("call"!==e.type)throw new Error("Failed to format the template with invalid cache");a.push(finalTemplate.run(e.template,e.call,t,n))}}),a.join("")},module.exports={format:finalTemplate,compile:finalTemplate.compile,execute:function(){return arguments[0].constructor===String?finalTemplate.execute.apply(finalTemplate,arguments):finalTemplate.run.apply(finalTemplate,[arguments[0].template,arguments[0],arguments[1],arguments[2]])}};