var foundation=require("./foundation.js"),template=require("./template.js"),timer=require("./timer.js"),home=null,loadStart=Date.now(),accumulatedCalls=0,tryCall=function(e){0===(accumulatedCalls=(accumulatedCalls+1)%async.maxAccumulatedCalls)?process.nextTick(e):e()},PENDING="pending",SUSPENDED="suspended",CALLING="calling",HELD="hold",FULFILLED="fulfilled",REJECTED="rejected",accelerated=null,setHiddenField=function(e,t,n){null===accelerated&&global.$&&global.$["!space"]&&(accelerated="yes"===global.$["!space"]("query").meta("query","accelerate")),global["@"]&&global["@"].process&&(accelerated=global["@"].process.accelerated);try{accelerated?e[t]=n:Object.defineProperty(e,t,{enumerable:!1,configurable:!0,value:n})}catch(i){e[t]=n}},getAsyncFileLine=function(e){if(!e.fileLine)return"unknown, line -1";var t=0;e.lines instanceof Function&&(t=e.lines.toString().split("\n").length-1);var n=e.fileLine.split(":").slice(0,-1).join(":"),i=parseInt(e.fileLine.split(":").slice(-1)[0]);return t?n+", line "+i+" to "+(i+t):n+", line "+i},nextAsyncID=1,Async=function(e,t,n,i,s,c){var r=this;n||(n=[]),c&&c.untracked&&(this.untracked=!0),this.fileLine=i,this.lines=s,this.id=nextAsyncID,++nextAsyncID,this.pool=foundation.objectize(t),this.preasync=c,this.state=PENDING,setHiddenField(this,"action",e),this.fulfilled=n,setHiddenField(this,"followingAsyncs",[]),setHiddenField(this,"pendingTaskAsyncs",[]),setHiddenField(this,"pendingRejectedActions",[function(e){this.followingAsyncs.forEach(function(t){t.state===PENDING?(t.state=REJECTED,t.fulfilled=this.fulfilled,t.pendingRejectedActions.length>0&&t.pendingRejectedActions.forEach(function(e){e.call(t.step,t.fulfilled)})):process.nextTick(function(){throw $.error(e),new Error("Invalid state for following async at "+getAsyncFileLine(t))})}.bind(this)),this.followingAsyncs=[]}.bind(this)]);var l=this,o=!1,a=0,d={pool:this.pool,hold:function(){var e=0,t=null;if(foundation.isKindOf(arguments[0],Number)&&(e=arguments[0]),foundation.isKindOf(arguments[arguments.length-1],Function)&&(t=arguments[arguments.length-1]),l.state!==CALLING){let e=new Error("Invalid state for async step at "+getAsyncFileLine(r));return process.nextTick(function(){throw e}),d}return l.state=HELD,e&&timer.delay(e,function(){l.state===HELD&&(d.reject(new Error("The hold of the async step has been timeout")),o=!0)}),t&&t.call(d),d},test:function(e,t){return e?d.reject(e):d.next.apply(d,Array.prototype.slice.call(arguments,1))},next:function(){if(delete unfinisheds[r.id],!o)if(l.hasException){let e=new Error("Unexpected async call for invalid async procedure at "+getAsyncFileLine(r));process.nextTick(function(){throw e})}else if(l.state===HELD||l.state===CALLING){l.fulfilled=Array.prototype.slice.call(arguments,0),l.state=FULFILLED;var e=l.pendingTaskAsyncs;setHiddenField(r,"pendingTaskAsyncs",[]),setHiddenField(r,"pendingRejectedActions",[]),e.forEach(function(e){tryCall(function(){call.call(e,l.fulfilled)})}),setHiddenField(r,"followingAsyncs",[])}else{let e=new Error("Invalid state for async step at "+getAsyncFileLine(r));process.nextTick(function(){throw e})}},retry:function(e,t){if(e||(e=1/0),!o)if(l.hasException){let e=new Error("Unexpected async call for invalid async procedure at "+getAsyncFileLine(l));process.nextTick(function(){throw e})}else if(l.state===CALLING)++a<e?(l.state=PENDING,call.call(l,l.input)):(t||(t="Too many retries has been acted"),d.reject(new Error(t)));else{let e=new Error("Invalid state for async step at "+getAsyncFileLine(l));process.nextTick(function(){throw e})}},reject:function(e){if(delete unfinisheds[r.id],!o)if(l.hasException)process.nextTick(function(){throw $.error(e),new Error("Unexpected async call for invalid async procedure at "+getAsyncFileLine(r))});else if(l.state===HELD||l.state===CALLING){if(!foundation.isKindOf(e,Error))if(e.message&&e.stack){var t=new Error;t.message=e.message,t.stack=e.stack,e=t}else e=new Error(e);l.fulfilled=e,l.state=REJECTED;var n=l.pendingRejectedActions;setHiddenField(r,"pendingTaskAsyncs",[]),setHiddenField(r,"pendingRejectedActions",[]),n.forEach(function(e){e.call(d,l.fulfilled)}),setHiddenField(r,"followingAsyncs",[])}else process.nextTick(function(){throw $.error(e),new Error("Invalid state for async step at "+getAsyncFileLine(r))})}};d.test.attach=function(e){return function(t,n){return t?d.reject(t):(e.apply(d,Array.prototype.slice.call(arguments,1)),d.next.apply(d,Array.prototype.slice.call(arguments,1)))}},d.reject.once=function(e){o||l.hasException||l.state!==HELD&&l.state!==CALLING||d.reject(e)},setHiddenField(this,"step",d)};Async.prototype.state=PENDING,Async.prototype.fulfilled=null;var call=function(e){n=this;if(this.state===PENDING){this.state=CALLING,this.input=e,foundation.isArrayLike(e)||(e=[e]),this.hasException=!1;try{this.action.apply(this.step,e)}catch(e){if(this.hasException=!0,delete unfinisheds[this.id],this.state!==CALLING&&this.state!==HELD)return void process.nextTick(function(){throw e});this.fulfilled=e,this.state=REJECTED;var t=this.pendingRejectedActions;setHiddenField(this,"pendingTaskAsyncs",[]),setHiddenField(this,"pendingRejectedActions",[]),t.forEach(function(e){e.call(this.step,this.fulfilled)}.bind(this)),setHiddenField(this,"followingAsyncs",[])}}else{var n=this;process.nextTick(function(){throw n.fileLine?new Error("Invalid state to call async task : "+n.fileLine):new Error("Invalid state to call async task")})}},unfinisheds={},getAllUnfinishedAsyncs=function(){return Object.keys(unfinisheds).map(function(e){return unfinisheds[e]}).filter(function(e){return!e.preasync||e.preasync.state===FULFILLED})};setHiddenField(Async.prototype,"untrack",function(){return this.untracked=!0,delete unfinisheds[this.id],this}),setHiddenField(Async.prototype,"then",function(e,t,n){t||(t=0),home||(home=require("./home.js"));var i=accelerated?"/tmp/unknown-file:0":home.getFileLine(1+t,0),s=new Async(e,this.pool,Array.prototype.slice.call(arguments,1),i,n||e,this);switch(this.followingAsyncs.push(s),this.state){case PENDING:case CALLING:case HELD:this.untracked||(unfinisheds[this.id]=this),this.pendingTaskAsyncs.push(s);break;case FULFILLED:call.call(s,this.fulfilled);break;case REJECTED:default:s.fulfilled=this.fulfilled,s.state=REJECTED}return s}),setHiddenField(Async.prototype,"rejected",function(e){switch(this.state){case PENDING:case CALLING:case HELD:this.pendingRejectedActions.push(e);break;case REJECTED:e.call(this.step,this.fulfilled)}return this}),setHiddenField(Async.prototype,"pipe",function(e,t){return this.then(function(){e.next.apply(e,arguments),this.next.apply(e,arguments)},1,1).rejected(function(n){t?foundation.isKindOf(t,Function)?t.call({next:e.next.bind(e),reject:e.reject.bind(e)},n):($.error(n),e.reject(t)):e.reject(n)})}),setHiddenField(Async.prototype,"catch",function(e,t){return this.then(function(){var e=Array.prototype.slice.call(arguments,0);e.unshift(null),this.next.apply(this,e)}).pipe(e,function(e){t?($.error(e),this.next(t)):this.next(e)})}),setHiddenField(Async.prototype,"resolve",function(){var e=Array.prototype.slice.call(arguments,0);return this.then(function(){this.next.apply(this,e)})}),setHiddenField(Async.prototype,"if",function(){var e=void 0,t=null;return 1===arguments.length?t=arguments[0]:(e=arguments[0],t=arguments[1]),this.then(function(n){(void 0!==e?template.execute(e,this.pool,{}):!!n)?t.apply(this,arguments):this.next()},1,t)}),setHiddenField(Async.prototype,"async",function(){var e=this;return async(function(){var t=this;e.then(function(){t.next.apply(e,arguments),this.next.apply(this,arguments)},0,1).rejected(this.reject)})}),setHiddenField(Async.prototype,"finished",function(e){return this.rejected(function(t){try{e(t)}catch(e){$.error(e)}}).then(function(){const t=Array.prototype.slice.call(arguments,0);t.unshift(null);try{e.apply(null,t)}catch(e){$.error(e)}},1,e),this}),setHiddenField(Async.prototype,"all",function(){var e=null,t=1,n=null;arguments.length>2?(e=arguments[0],t=arguments[1],n=arguments[2]):2===arguments.length?(foundation.isKindOf(arguments[0],Number)?t=arguments[0]:e=arguments[0],n=arguments[1]):1===arguments.length&&(n=arguments[0]);var i=this.then(function(){e=foundation.isKindOf(e,String)?foundation.copyAsArray(this.pool[e]):e?foundation.copyAsArray(e):foundation.copyAsArray(arguments[0]);var s=this,c=0,r=0,l=0,o=[],a=!1,d=function(u){if(u<e.length){++r,++c;var f=e[u],h=0,p=CALLING,y=!1,E={hold:function(){var e=0,t=null;if(foundation.isKindOf(arguments[0],Number)&&(e=arguments[0]),foundation.isKindOf(arguments[arguments.length-1],Function)&&(t=arguments[arguments.length-1]),p!==CALLING){let e=new Error("Invalid state for async all at "+getAsyncFileLine(i));return process.nextTick(function(){throw e}),E}return p=HELD,e&&timer.delay(e,function(){p===HELD&&(--c,E.reject(new Error("The hold of the async all has been timeout")),y=!0)}),t&&t.call(E),E},test:function(e,t){return e?E.reject(e):E.next.apply(E,Array.prototype.slice.call(arguments,1))},next:function(e){if(o[u]=e,!y&&!a)if(p===HELD||p===CALLING)p=FULFILLED,--c,++l,tryCall(function(){d(r)});else{let e=new Error("Invalid state for async all at "+getAsyncFileLine(i));process.nextTick(function(){throw e})}},retry:function(t,c){if(t||(t=1/0),!y&&!a)if(p===CALLING)if(++h<t)try{n.call(E,f,u,e)}catch(e){if(p!==CALLING&&p!==HELD)return void process.nextTick(function(){throw e});p=REJECTED,s.reject(e)}else c||(c="Too many retries has been acted"),E.reject(new Error(c));else process.nextTick(function(){throw new Error("Invalid state for async step at "+getAsyncFileLine(i))})},reject:function(e){y||a||(a=!0,p!==FULFILLED&&p!==REJECTED?(--c,p=REJECTED,s.reject.apply(s,arguments)):process.nextTick(function(){throw $.error(e),new Error("Invalid state for async all")}))},pool:s.pool};E.test.attach=function(e){return function(t,n){return t?E.reject(t):(e.apply(E,Array.prototype.slice.call(arguments,1)),E.next.apply(E,Array.prototype.slice.call(arguments,1)))}},E.reject.once=function(e){y||p!==FULFILLED&&p!==REJECTED&&E.reject(e)};try{n.call(E,f,u,e)}catch(e){if(p!==CALLING&&p!==HELD){if(a)return;return void process.nextTick(function(){throw e})}p=REJECTED,a=!0,s.reject(e)}p!==CALLING&&p!==HELD||r<e.length&&(c<t||-1===t)&&tryCall(function(){d(r)})}else 0===c&&l===e.length&&(l=-1/0,s.next(o))};d(0)},1,n);switch(i.state){case PENDING:case CALLING:case HELD:this.untracked||(unfinisheds[i.id]=i)}return i});var async=function(e){var t=e;foundation.isKindOf(e,Function)||(t=function(){this.next(e)}),home||(home=require("./home.js"));var n=accelerated?"/tmp/unknown-file:0":home.getFileLine(1,0),i=new Async(t,{},[],n,e);return call.call(i),i};async.resolve=function(){var e=foundation.copyAsArray(arguments);return async(function(){this.next.apply(this,e)})},async.reject=function(e){return async(function(){this.reject(e)})},async.all=function(e){var t=async();return t.all.apply(t,arguments)},async.isAsync=function(e){return e instanceof Async},async.ensure=function(e){return async.isAsync(e)?e:async.resolve(e)},async.maxAccumulatedCalls=128,async.getUnfinisheds=getAllUnfinishedAsyncs,module.exports=async;var loadEnd=Date.now();