var foundation=require("./foundation.js"),PENDING="pending",SUSPENDED="suspended",CALLING="calling",HELD="hold",FULFILLED="fulfilled",REJECTED="rejected",nextJobs=[],scheduledJobs=[],Job=function(e,t,n,a){this.id=null,this.type=e,this.time=t,this.state=SUSPENDED,this.called=!1,this.action=a,this.name=n;var s=this;this.act=function(){if("once"!==s.type.split(".")[0]||!s.called)return"repeated.schedule"===s.type&&s.handle&&(clearTimeout(s.handle),delete s.handle),-1===[REJECTED,SUSPENDED].indexOf(s.state)&&(s.called=!0,s.action.apply(s,arguments),"once"===s.type.split(".")[0]&&s.cancel()),s},this.cancel=function(){if(s.state!==REJECTED){var e=scheduledJobs.indexOf(s);switch(-1!==e&&scheduledJobs.splice(e,1),s.state=REJECTED,s.type){case"once.next":-1!==(e=nextJobs.indexOf(s))&&nextJobs.splice(e,1);break;case"once.timeout":case"once.date":case"repeated.schedule":clearTimeout(s.handle),delete s.handle;break;case"repeated.timer":clearInterval(s.handle)}}return s},this.suspend=function(){if("once"!==s.type.split(".")||!s.called){if(s.state!==SUSPENDED&&s.state!==REJECTED){s.state=SUSPENDED;var e=scheduledJobs.indexOf(s);switch(-1!==e&&scheduledJobs.splice(e,1),s.type){case"once.next":-1!==(e=nextJobs.indexOf(s))&&nextJobs.splice(e,1);break;case"once.timeout":case"repeated.schedule":case"once.date":clearTimeout(s.handle),delete s.handle;break;case"repeated.timer":clearInterval(s.handle),delete s.handle}}return s}},this.resume=function(){if(s.state===SUSPENDED)switch(s.state=PENDING,scheduledJobs.push(s),s.type){case"once.next":0===nextJobs.length&&process.nextTick(function(){var e=nextJobs;nextJobs=[],e.forEach(function(e){e.act()})}),nextJobs.push(s);break;case"once.timeout":case"once.date":s.handle=setTimeout(s.act,s.time-(new Date).getTime());break;case"repeated.schedule":s.handle=setTimeout(s.act,s.time);break;case"repeated.timer":s.handle=setInterval(s.act,s.time);break;case"once.tick":process.nextTick(s.act)}return s},this.schedule=function(){return s.state===PENDING&&"repeated.schedule"===s.type&&s.called&&(s.called=!1,s.handle&&clearTimeout(s.handle),s.handle=setTimeout(s.act,s.time)),s},this.act.job=s},delay=function(){var e=null,t=null,n=null;foundation.isKindOf(arguments[0],Function)?(e=-1,t=arguments[0],n=arguments[1]):(e=arguments[0],t=arguments[1],n=arguments[2]);var a=null;if(-2===e)a=new Job("once.tick",0,n,t);else if(-1===e)a=new Job("once.next",0,n,t);else if(foundation.isKindOf(e,Number))a=new Job("once.timeout",(new Date).getTime()+e,n,t);else{if(!foundation.isKindOf(e,Date))throw new Error("Unknown type of time for job to delay");a=new Job("once.date",e.getTime(),n,t)}return a.resume(),a},plan=function(e,t,n){return foundation.isKindOf(e,Number)&&(e=new Date(e)),delay(e,t,n)},schedule=function(e,t,n){return new Job("repeated.schedule",e,n,t).resume()},timer=function(e,t,n){return new Job("repeated.timer",e,n,t).resume()},getJobs=function(){return scheduledJobs.slice(0)};module.exports={delay:delay,plan:plan,schedule:schedule,timer:timer,getJobs:getJobs};