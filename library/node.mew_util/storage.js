var crypto=require("crypto"),fs=require("fs"),os=require("os"),path=require("path"),async=require("./async.js");if("js"!==process.arch)var task=require("./task.js"),stream=require("./stream.js");var timer=require("./timer.js"),isInMSYS=require("./os.js").isInMSYS,isWindows=require("./os.js").isWindows,mimes=require("./mimes.js"),uuid=require("./uuid.js"),foundation=require("./foundation.js"),javaWrap=null;"android"===process.platform&&(javaWrap=process.binding("java_wrap"));var msysMounts={};if(isInMSYS()){var fstabPath="C:\\MewSYS\\etc\\fstab";try{fstabPath=task.executeCommandSync("cygpath",["--windows","--absolute","/etc/fstab"],!0).stdout.toString("utf8").trim()}catch(e){}msysMounts[path.dirname(path.dirname(fstabPath))]="/",fs.readFileSync(fstabPath).toString("utf8").split("\n").map(function(e){return e.trim()}).filter(function(e){return e.length>0&&"#"!==e[0]}).forEach(function(e){var t=e.split(/\s+/);if("cygdrive"===t[2])for(var i=0;i<26;)msysMounts[String.fromCharCode("A".charCodeAt(0)+i)+":"]=t[1]+"/"+String.fromCharCode("a".charCodeAt(0)+i),++i;else"ntfs"!==e[2]&&"fat32"!==e[2]&&"exfat"!==e[2]||(msysMounts[t[0]]=t[1])})}var home=null,Logger=null,suggestAsync=function(e,t){if(e){Logger||(Logger=require("./logger.js")),home||(home=require("./home.js"));var i=home.getFileLine(1,4,!1,function(e,t,i,n,r){return-1===e.indexOf(__dirname)},16);return i||(i=home.getFileLine(1,4,!1)),Logger.default.warn(Logger.fileLine(i),"Callback is deprecated, please use async"),t.then(function(){var t=Array.prototype.slice.call(arguments,0);t.unshift(null),e.apply(null,t),this.next()}).rejected(function(t){e(t)}),t}return t},fileExists=function(e,t){return fileExistsUtilFS(fs,e,t)},fileExistsUtilFS=function(e,t,i){try{e.accessSync(getRealOSPath(t),e.constants.F_OK)}catch(e){return!1}return!0},dirExists=function(e,t){return dirExistsUtilFS(fs,e,t)},dirExistsUtilFS=function(e,t,i){var n=null;try{n=e.statSync(getRealOSPath(t))}catch(e){return!1}return n.isDirectory()},onlyFileExists=function(e,t){return onlyFileExistsUtilFS(fs,e,t)},onlyFileExistsUtilFS=function(e,t,i){var n=null;try{n=e.statSync(getRealOSPath(t))}catch(e){return!1}return n.isFile()},tryToAccessFile=function(e,t){return tryToAccessFileUtilFS(fs,e,t)},tryToAccessFileUtilFS=function(e,t,i){return suggestAsync(i,async(function(){e.access(getRealOSPath(t),e.constants.F_OK,this.test)}))},isExecutable=function(e){return isExecutableUtilFS(fs,e)},isExecutableUtilFS=function(e,t){if(!isInMSYS()||e.su){try{e.accessSync(getRealOSPath(t),e.constants.X_OK)}catch(e){return!1}return!0}try{return/(^|[^a-zA-Z0-9])executable([^a-zA-Z0-9]|$)/.test(task.executeCommandSync("file",[getRealOSPath(t)],!0).stdout.toString("utf8"))}catch(e){return!1}},getFileStats=function(){var e=Array.prototype.slice.call(arguments,0);return e.unshift(fs),getFileStatsUtilFS.apply(this,e)},getFileStatsUtilFS=function(e,t){var i="stat",n=null;return 4===arguments.length?(arguments[2]&&(i="lstat"),n=arguments[3]):n=arguments[2],suggestAsync(n,async(function(){e[i](getRealOSPath(t),function(e,t){if(e)this.reject(e);else{var i="unknown";t.isFile()?i="file":t.isDirectory()?i="dir":t.isSymbolicLink()?i="link":t.isSocket()?i="socket":t.isBlockDevice()?i="device.block":t.isCharacterDevice()?i="device.character":t.isFIFO()&&(i="fifo"),this.next({type:i,mode:t.mode,node:t.node,size:t.size,accessTime:t.atime,modifyTime:t.mtime,changeTime:t.ctime,createTime:new Date(Math.min(t.atime.getTime(),t.mtime.getTime(),t.ctime.getTime(),t.birthtime.getTime())),rawStats:t})}}.bind(this))}))},getFileStatsSync=function(){var e=Array.prototype.slice.call(arguments,0);return e.unshift(fs),getFileStatsSyncUtilFS.apply(this,e)},getFileStatsSyncUtilFS=function(e,t){var i="statSync";3===arguments.length&&arguments[2]&&(i="lstatSync");var n=e[i](getRealOSPath(t)),r="unknown";return n.isFile()?r="file":n.isDirectory()?r="dir":n.isSymbolicLink()?r="link":n.isSocket()?r="socket":n.isBlockDevice()?r="device.block":n.isCharacterDevice()?r="device.character":n.isFIFO()&&(r="fifo"),{type:r,mode:n.mode,node:n.node,size:n.size,accessTime:n.atime,modifyTime:n.mtime,changeTime:n.ctime,createTime:new Date(Math.min(n.atime.getTime(),n.mtime.getTime(),n.ctime.getTime(),n.birthtime.getTime())),rawStats:n}},setFileMode=function(e,t,i){return setFileModeUtilFS(fs,e,t,i)},setFileModeUtilFS=function(e,t,i,n){return suggestAsync(n,async(function(){e.chmod(getRealOSPath(t),i,this.test)}))},setFileModeSync=function(e,t){return setFileModeSyncUtilFS(fs,e,t)},setFileModeSyncUtilFS=function(e,t,i){return e.chmodSync(getRealOSPath(t),i)},getExtname=function(e){return/\.tar\.(gz|bz2|xz)$/.test(e)?"."+e.split(".").slice(-2).join("."):path.extname(e)},getBasename=function(e,t){return t||(t=getExtname(e)),path.basename(e,t)},getFilename=function(e){return e.split(getPathSeparator()).slice(-1)[0]},getDirname=function(e){return isRootPath(e)?getSimOSPath(path.dirname(e),!0):ensurePosixPath(path.dirname(e))},changeExtname=function(e,t){return t||(t=""),ensurePosixPath(path.join(path.dirname(e),getBasename(e)+t))},appendBasename=function(e,t,i){var n=path.extname(e);return i||(i=n),ensurePosixPath(path.join(path.dirname(e),path.basename(e,n)+t+i))},getMime=function(e){var t=path.extname(e),i=mimes[t];return i||(i="application/octet-stream"),i},getHomeDir=function(e){var t=process.env["win32"==process.platform.toLowerCase()?"USERPROFILE":"HOME"];return javaWrap&&(t=javaWrap.getHomePath()),t||(t="/home/guest"),getSimOSPath(e?path.resolve(t,e):t,!0)},getTempDir=function(e){var t=os.tmpdir();return t||(t=process.env.TMPDIR),t||(t=process.env.TMP),t||(t=process.env.TEMP),e?getSimOSPath(path.join(t,e),!0):getSimOSPath(t,!0)},getTempFile=function(e){return e||(e=""),getTempDir(uuid.createUUID()+e)},makeDirs=function(){var e=Array.prototype.slice.call(arguments,0);return e.unshift(fs),makeDirsUtilFS.apply(this,e)},makeDirsUtilFS=function(e){var t=null,i=[],n=null;switch(arguments.length){case 0:case 1:throw new Error("Invalid arguments to make dirs");case 2:arguments[1]instanceof Array?i=arguments[1]:t=arguments[1];break;case 3:arguments[1]instanceof Array?(i=arguments[1],n=arguments[2]):arguments[2]instanceof Function?(t=arguments[1],n=arguments[2]):foundation.isKindOf(arguments[2],String)?(t=arguments[1],1===(i=arguments[2].toString().split(",").map(function(e){return e.trim()})).length&&isRootPath(i[0])&&(i=[t,i[0]],t=null)):(t=arguments[1],i=arguments[2]);break;case 4:default:arguments[3]instanceof Function?(t=arguments[1],i=arguments[2].toString().split(",").map(function(e){return e.trim()}),n=arguments[3]):i=Array.prototype.slice.call(arguments,1)}return t&&(i.length>0?i=i.map(function(e){return resolvePath(t,e)}):i.push(t)),suggestAsync(n,async.all(i,function(t){makeDirUtilFS(e,t).pipe(this)}))},makeDirsSync=function(){var e=Array.prototype.slice.call(arguments,0);return e.unshift(fs),makeDirsSyncUtilFS.apply(this,e)},makeDirsSyncUtilFS=function(e){var t=null,i=[];switch(arguments.length){case 0:case 1:throw new Error("Invalid arguments to make dir tree");case 2:arguments[1]instanceof Array?i=arguments[1]:arguments[1].constructor===String&&(t=arguments[1]);break;case 3:foundation.isKindOf(arguments[2],String)?(t=arguments[1],i=arguments[2].toString().split(",").map(function(e){return e.trim()})):(t=arguments[1],i=arguments[2])}t&&(i.length>0?i=i.map(function(e){return resolvePath(t,e)}):i.push(t)),i.forEach(function(t){makeDirSyncUtilFS(e,t)})},makeDir=function(e){var t=Array.prototype.slice.call(arguments,0);return t.unshift(fs),makeDirUtilFS.apply(this,t)},makeDirUtilFS=function(e,t){var i,n;switch(arguments.length){case 3:arguments[2]instanceof Function?n=arguments[2]:i=arguments[2];break;case 4:default:i=arguments[2],n=arguments[3]}var r=(t=getRealOSPath(t)).split(getPathSeparator());return suggestAsync(n,async(function(){e.exists(t,function(n){if(n)this.next();else{var a=r.slice(0,-1).join(path.sep);makeDirUtilFS(e,a,i).then(function(){e.mkdir(t,i,function(e){e&&"EEXIST"!==e.code?this.reject(e):this.next()}.bind(this))}).pipe(this)}}.bind(this))}))},makeDirSync=function(e,t){return makeDirSyncUtilFS(fs,e,t)},makeDirSyncUtilFS=function(e,t,i){var n=(t=getRealOSPath(t)).split(getPathSeparator());e.existsSync(t)||(makeDirSyncUtilFS(e,n.slice(0,-1).join(path.sep),i),e.mkdirSync(t,i))},copyFileSync=function(e,t){return copyFileSyncUtilFS(fs,e,t)},copyFileSyncUtilFS=function(e,t,i){if(t=getRealOSPath(t),i=getRealOSPath(i),!e.existsSync(t))throw new Error("File not found");e.statSync(t).isDirectory()?(e.existsSync(i)?e.statSync(i).isDirectory()||deleteFileSyncUtilFS(e,i):(makeDirSyncUtilFS(e,i),e.chmodSync(i,511&e.statSync(t).mode)),e.readdirSync(t).forEach(function(n){copyFileSyncUtilFS(e,path.resolve(t,n),path.resolve(i,n))})):(e.existsSync(i)?deleteFileSyncUtilFS(e,i):makeDirSyncUtilFS(e,path.dirname(i)),e.writeFileSync(i,e.readFileSync(t)),e.chmodSync(i,511&e.statSync(t).mode))},copyFile=function(e,t,i){return copyFileUtilFS(fs,e,t,i)},copyFileUtilFS=function(e,t,i,n){return t=getRealOSPath(t),i=getRealOSPath(i),suggestAsync(n,async(function(){e.exists(t,function(n){n?e.stat(t,function(n,r){if(n)this.reject(n);else if(r.isDirectory()){var a=function(){e.readdir(t,function(n,r){async.all(r,function(n){copyFileUtilFS(e,path.resolve(t,n),path.resolve(i,n)).pipe(this)}).pipe(this)}.bind(this))}.bind(this);e.exists(i,function(t){t?e.stat(i,function(t,n){n.isDirectory()?a():deleteFileUtilFS(e,i).then(function(){a()}).rejected(this.reject)}.bind(this)):makeDirUtilFS(e,i).then(function(){e.chmod(i,511&r.mode,function(e){e?this.reject(e):a()}.bind(this))}).rejected(this.reject)}.bind(this))}else e.exists(i,function(n){var a=function(){var n=e.createReadStream(t),a=e.createWriteStream(i);n.pipe(a,{end:!0});var s=!1;n.on("error",function(e){s||(s=!0,this.reject(e))}.bind(this)),a.on("error",function(e){s||(s=!0,this.reject(e))}.bind(this)),a.on("finish",function(){s||(s=!0,e.chmod(i,511&r.mode,this.test))}.bind(this))}.bind(this);n?deleteFileUtilFS(e,i).then(function(){a()}).rejected(this.reject):makeDirUtilFS(e,path.dirname(i)).then(function(){a()}).rejected(this.reject)}.bind(this))}.bind(this)):this.reject(new Error("File not found : "+t))}.bind(this))}))},deleteFile=function(e,t){return deleteFileUtilFS(fs,e,t)},deleteFileUtilFS=function(e,t,i){return t=getRealOSPath(t),suggestAsync(i,async(function(){e.lstat(t,function(i,n){i?"ENOENT"!==i.code?this.reject(i):this.next():n.isDirectory()?e.readdir(t,function(i,n){i?this.reject(i):async.all(n,function(i){deleteFileUtilFS(e,path.resolve(t,i)).pipe(this)}).then(function(){e.rmdir(t,this.test)}).pipe(this)}.bind(this)):e.unlink(t,this.test)}.bind(this))}))},deleteFiles=function(){var e=Array.prototype.slice.call(arguments,0);return e.unshift(fs),deleteFilesUtilFS.apply(this,e)},deleteFilesUtilFS=function(e){var t=[],i=null;return arguments[arguments.length-1]instanceof Function?(i=arguments[arguments.length-1],t=Array.prototype.slice.call(arguments,1,arguments.length-1)):t=Array.prototype.slice.call(arguments,1),1===t.length&&t[0]instanceof Array&&(t=t[0]),suggestAsync(i,async.all(t,function(t){deleteFileUtilFS(e,t).pipe(this)}))},deleteFileSync=function(e){return deleteFileSyncUtilFS(fs,e)},deleteFileSyncUtilFS=function(e,t){e.existsSync(t)&&(e.lstatSync(t).isDirectory()?(e.readdirSync(t).forEach(function(i){deleteFileSyncUtilFS(e,path.resolve(t,i))}),e.rmdirSync(t)):e.unlinkSync(t))},deleteFilesSync=function(){var e=Array.prototype.slice.call(arguments,0);return e.unshift(fs),deleteFilesSyncUtilFS.apply(this,e)},deleteFilesSyncUtilFS=function(e){var t=Array.prototype.slice.call(arguments,1);1===t.length&&t[0]instanceof Array&&(t=t[0]),t.forEach(function(t){deleteFileSyncUtilFS(e,t)})},scanFile=function(e,t,i,n){return scanFileUtilFS(fs,e,t,i,n)},scanFileUtilFS=function(e,t,i,n,r){t=getRealOSPath(t),n||(n=function(e){return!0}),void 0!==i&&null!==i||(i=1);var a=[];return suggestAsync(r,async(function(){e.exists(t,function(r){r?e.stat(t,function(r,s){if(r)this.reject(r);else{var l="unknown";s.isFile()?l="file":s.isDirectory()?l="dir":s.isSymbolicLink()?l="link":s.isSocket()?l="socket":s.isBlockDevice()?l="device.block":s.isCharacterDevice()?l="device.character":s.isFIFO()&&(l="fifo");var c={type:l,path:getSimOSPath(t,!0),mode:s.mode,node:s.node,size:s.size,userID:s.uid,groupID:s.gid,accessTime:s.atime,modifyTime:s.mtime,changeTime:s.ctime,createTime:new Date(Math.min(s.atime.getTime(),s.mtime.getTime(),s.ctime.getTime(),s.birthtime.getTime()))};n(c)?s.isDirectory()&&(i<=-1||i>0)?e.readdir(t,function(r,s){if(r)this.reject(r);else{var l=0,c=function(){if(l<s.length){var r=resolvePath(t,s[l]);++l,scanFileUtilFS(e,r,i-1,function(e){return!!n(e)&&(a.push({type:e.type,path:ensurePosixPath(path.relative(t,getRealOSPath(e.path))),mode:e.mode,node:e.node,size:e.size,userID:e.userID,groupID:e.groupID,accessTime:e.accessTime,modifyTime:e.modifyTime,changeTime:e.changeTime,createTime:e.createTime}),!0)}).then(function(e){this.next(),c()}).rejected(this.reject)}else this.next(a)}.bind(this);c()}}.bind(this)):s.isFile()?this.next([c]):this.next(a):this.next(a)}}.bind(this)):this.next(a)}.bind(this))}))},scanFileSync=function(e,t,i){return scanFileSyncUtilFS(fs,e,t,i)},scanFileSyncUtilFS=function(e,t,i,n){t=getRealOSPath(t),n||(n=function(e){return!0}),void 0!==i&&null!==i||(i=1);var r=[];if(e.existsSync(t)){var a=e.statSync(t),s="unknown";a.isFile()?s="file":a.isDirectory()?s="dir":a.isSymbolicLink()?s="link":a.isSocket()?s="socket":a.isBlockDevice()?s="device.block":a.isCharacterDevice()?s="device.character":a.isFIFO()&&(s="fifo");var l={type:s,path:getSimOSPath(t,!0),mode:a.mode,node:a.node,size:a.size,userID:a.uid,groupID:a.gid,accessTime:a.atime,modifyTime:a.mtime,changeTime:a.ctime,createTime:new Date(Math.min(a.atime.getTime(),a.mtime.getTime(),a.ctime.getTime(),a.birthtime.getTime()))};n(l)&&(a.isDirectory()&&(-1===i||i>0)?e.readdirSync(t).forEach(function(a){var s=path.resolve(t,a);scanFileSyncUtilFS(e,s,i-1,function(e){return r.push({type:e.type,path:ensurePosixPath(path.relative(t,getRealOSPath(e.path))),mode:e.mode,node:e.node,size:e.size,userID:e.userID,groupID:e.groupID,accessTime:e.accessTime,modifyTime:e.modifyTime,changeTime:e.changeTime,createTime:e.createTime}),n(e)})}):a.isFile()&&r.push(l))}return r},getSimOSPath=function(e,t){if(isInMSYS()){if("/"===e[0])return e.replace(getPathSeparator(),"/");e=path.resolve(e);var i=Object.keys(msysMounts).filter(function(t){return t==e.toUpperCase()||(t+"\\"===e.substring(0,t.length+1).toUpperCase()||void 0)}).sort(function(e,t){return msysMounts[e].length>msysMounts[t].length?1:msysMounts[e].length<msysMounts[t].length?-1:0});return resolvePath(msysMounts[i[0]],path.relative(i[0]+"\\",e)).replace(getPathSeparator(),"/")}return isWindows()?t?(/^[a-z]:/i.test(e)&&(e=e.replace(/^[a-z]:/i,function(e){return"/mnt/"+e[0].toLowerCase()})),ensurePosixPath(resolvePath(e))):(/^\/mnt\/[a-z]/.test(e)&&(e=e.replace(/^\/mnt\/[a-z]/,function(e){return e.slice(-1).toUpperCase()+":\\"})),path.resolve(e)):path.resolve(e)},getRealOSPath=function(){var e=resolvePath.apply(this,arguments);if(isInMSYS()){if("/"!==e[0])return path.resolve(e);e=ensurePosixPath(resolvePath(e));var t=Object.keys(msysMounts).filter(function(t){return msysMounts[t]==e||("/"===msysMounts[t]||(msysMounts[t]+"/"===e.substring(0,msysMounts[t].length+1)||void 0))}).sort(function(e,t){return e.length>t.length?1:e.length<t.length?-1:0});return standardizePath(resolvePath(t[0],path.relative(msysMounts[t[0]],e)))}return isWindows()&&"/"===e[0]&&/^\/mnt\/[a-z]/.test(e)?standardizePath(resolvePath(e.replace(/^\/mnt\/[a-z]/,function(e){return e.slice(-1).toUpperCase()+":"}))):path.resolve(e)},getPathSeparator=function(){return/[\\\/]+/g},ensurePosixPath=function(e){return resolvePath(e).replace(getPathSeparator(),"/")},standardizePath=function(e){return resolvePath(e).replace(getPathSeparator(),path.sep)},moveFile=function(e,t,i){return moveFileUtilFS(fs,e,t,i)},moveFileUtilFS=function(e,t,i,n){return suggestAsync(n,async(function(){e.rename(getRealOSPath(t),getRealOSPath(i),this.test)}))},moveFileSync=function(e,t){return moveFileSyncUtilFS(fs,e,t)},moveFileSyncUtilFS=function(e,t,i){e.renameSync(getRealOSPath(t),getRealOSPath(i))},resolvePath=function(){for(var e=[],t=0;t<arguments.length;){var i=arguments[t],n=i.split(getPathSeparator());if(isRootPath(i)){var r=/^[a-z]:$/;r.test(e[0])&&!r.test(n[0])?(e=[e[0]],n=n.splice(1)):e=[]}n.forEach(function(t,i){switch(t){case"":0===i&&e.push(t);break;case".":break;case"..":e.length>0&&".."!==e[e.length-1]&&""!==e[e.length-1]?e.pop():e.push(t);break;default:e.push(t)}}),++t}var a=e.join("/");return":"===a[1]&&2===a.length&&(a+="/"),a},isRootPath=function(e){return/^([a-z]:)?[\\\/]/gim.test(e)},isJustRootPath=function(e){return/^([a-z]:)?[\\\/]$/gim.test(e)},getRealPath=function(e){return getRealPathUtilFS(fs,e)},getRealPathUtilFS=function(e,t){return getSimOSPath(e.realpathSync(getRealOSPath(t)),!0)},linkFile=function(e,t,i){return linkFileUtilFS(fs,e,t,i)},linkFileUtilFS=function(e,t,i,n){t=getRealOSPath(t),i=standardizePath(i);var r=getRealOSPath(resolvePath(t,i));return suggestAsync(n,async(function(){e.stat(r,function(n,r){n?this.reject(n):r.isDirectory()?e.symlink(i,t,"dir",this.test):e.symlink(i,t,"file",this.test)}.bind(this))}))},linkFileSync=function(e,t){return linkFileSyncUtilFS(fs,e,t)},linkFileSyncUtilFS=function(e,t,i){t=getRealOSPath(t),i=standardizePath(i);var n=getRealOSPath(resolvePath(t,i));e.statSync(n).isDirectory()?e.symlinkSync(i,t,"dir"):e.symlinkSync(i,t,"file")},watchFile=function(e,t){return watchFileUtilFS(fs,e,t)},watchFileUtilFS=function(e,t,i){var n=function(e){return"$"+e},r=function(e,t,n){try{i(e,t,n)}catch(e){process.nextTick(function(){throw e})}},a=function(e,t){var i=[];for(var n in e)"$"===n[0]&&i.push(n.substring(1));i.forEach(function(i){t(i,e["$"+i])})};t=getSimOSPath(getRealPath(t),!0);var s={},l={},c={},o=function(t,i,r){var a=[],c=[],o=[],u={};for(var h in s)"$"===h[0]&&h.substring(1,t.length+2)===t+"/"&&-1===h.indexOf("/",t.length+3)&&(u[h]=s[h]);var S={};for(var h in l)"$"===h[0]&&h.substring(1,t.length+2)===t+"/"&&-1===h.indexOf("/",t.length+3)&&(S[h]=l[h]);l[n(t)]||(l[n(t)]=!0,a.push(t));var f=!1,F=[];try{F=e.readdirSync(getRealOSPath(t))}catch(e){f=!0}if(!f){F.forEach(function(r){var o=null,h=null,F=null;try{h=getRealPath(t+"/"+r),F=e.statSync(getRealOSPath(h)).isDirectory()}catch(e){o=e}o?f=!0:F?(delete S[n(h)],s[n(h)]&&(delete s[n(h)],i("file",h)),l[n(h)]||(l[n(h)]=!0,a.push(h))):(delete u[n(h)],l[n(h)]&&(delete l[n(h)],i("dir",h)),s[n(h)]||(s[n(h)]=!0,c.push(h)))});for(var h in u)"$"===h[0]&&(delete s[h],i("file",u[h]));for(var h in S)"$"===h[0]&&(delete l[h],i("dir",S[h]))}return{files:c,dirs:a,links:o}},u=function(t,i,a,S){if(!c[n(t)]){var f=null;try{c[n(t)]=e.watch(getRealOSPath(t),{"recursive ":!1},function(i,a){var o=t+"/"+a;if(e.existsSync(getRealOSPath(o))){var S=null,f=null;try{o=getSimOSPath(getRealPath(o)),f=e.statSync(getRealOSPath(o)).isDirectory()?"dir":"file"}catch(e){S=e}if(!S){var F=!1;"dir"===f?l[n(o)]||(F=!0,l[n(o)]=!0,s[n(o)]):"file"===f&&(s[n(o)]||(F=!0,s[n(o)]=!0,l[n(o)])),F?r("created",f,o):"dir"!==f&&r("modified",f,o),"dir"!==f||c[n(o)]||u(o,!0,!1)}}else{f="file";l[n(o)]&&(f="dir"),h(o,!1)}})}catch(e){f=e}if(!f){c[n(t)].on("error",function(e){});var F=o(t,function(e,t){h(t,!0)},a);F.dirs.forEach(function(e){r(a?"found":"created","dir",e),i&&u(e,!1,a)}),F.files.forEach(function(e){r(a?"found":"created","file",e)})}}},h=function(e,t){if(!t){a=[];for(var i in s)"$"===i[0]&&a.push(i.substring(1));a.forEach(function(t){t.substring(0,e.length+1)===e+"/"&&(delete s[n(t)],r("deleted","file",t))}),s[n(e)]&&(delete s[n(e)],r("deleted","file",e));a=[];for(var i in l)"$"===i[0]&&a.push(i.substring(1));a.forEach(function(t){t.substring(0,e.length+1)===e+"/"&&(delete l[n(t)],r("deleted","dir",t))}),l[n(e)]&&(delete l[n(e)],r("deleted","dir",e))}if(c[n(e)]){var a=[];for(var i in c)"$"===i[0]&&a.push(i.substring(1));a.forEach(function(t){t.substring(0,e.length+1)===e+"/"&&(c[n(t)].close(),delete c[n(t)])}),c[n(e)].close(),delete c[n(e)]}};return e.statSync(getRealOSPath(t)).isDirectory()?u(t,!0,!0,!0):s[n(t)]=!0,{getType:function(e){return l.hasOwnProperty(n(e))?"dir":s.hasOwnProperty(n(e))?"file":"none"},forEachFile:function(e){a(s,e)},forEachDir:function(e){a(l,e)},stop:function(){a(c,function(e,t){t.close()})}}},isUnderDir=function(e,t,i){var n=getRelativePath(e,t,!0);return!/^\.\.[\\//]/.test(n)&&!isRootPath(n)&&!("."===n&&!i)},resolveRootBasedPath=function(e,t){var i=getRelativePath(e,t);return"."===i[0]&&"."!==i||isRootPath(i)?getSimOSPath(t,!0):i},getRelativePath=function(e,t,i){if(isRootPath(e)||isRootPath(t)){if(!isRootPath(t))return resolvePath(t);e=getRealOSPath(e),t=getRealOSPath(t)}var n=path.relative(e,t);return n?isRootPath(n)?getSimOSPath(n,!0):ensurePosixPath(n):i?".":""},lockFile=function(e){var t=Array.prototype.slice.call(arguments,0);return t.unshift(fs),lockFileUtilFS.apply(this,t)},lockFileUtilFS=function(e,t){var i=-1,n=null;4===arguments.length?(i=arguments[2],n=arguments[3]):foundation.isKindOf(arguments[2],Number)?i=arguments[2]:(i=-1,n=arguments[2]);var r=1/0;i>=0&&(r=Date.now()+i);var a=getRealOSPath(getRealPath(t))+".lck";return suggestAsync(n,async(function(){var t=this;async(function(){e.unlink(a,function(e){e&&"ENOENT"!==e.code?this.reject(e):this.next()}.bind(this))}).then(function(){e.open(a,"wx",function(t,i){if(t)this.reject(t);else{var n=!1;this.next(function(){return n?async.reject(new Error("File has already been unlocked")):(n=!0,async(function(){e.close(i,function(t){t?(e.unlink(a,function(e){throw e}),this.reject(t)):e.unlink(a,function(e){e&&"ENOENT"!==e.code?this.reject(e):this.next()}.bind(this))}.bind(this))}))})}}.bind(this))}).rejected(function(){Date.now()<r?timer.delay(100,function(){Date.now()<r?this.retry():t.reject(new Error("Lock file Timeout"))}.bind(this)):t.reject(new Error("Lock file Timeout"))}.bind(this)).then(function(e){this.next(e),t.next(e)})}))},changeRootPath=function(e,t,i){return resolvePath(i,resolveRootBasedPath(t,e))},readFile=function(e){var t=Array.prototype.slice.call(arguments,0);return t.unshift(fs),readFileUtilFS.apply(this,t)},readFileUtilFS=function(e,t){var i=null,n=null;return foundation.isKindOf(arguments[2],String)?(i=arguments[2],n=arguments[3]):n=arguments[2],suggestAsync(n,async(function(){e.readFile(getRealOSPath(t),function(e,t){if(e)this.reject(e);else{var n=null;try{switch(i){case"text":n=t.toString("utf8");break;case"json":n=JSON.parse(t.toString("utf8"));break;default:n=t}}catch(e){return void this.reject(e)}this.next(n)}}.bind(this))}))},readFileSync=function(e){var t=Array.prototype.slice.call(arguments,0);return t.unshift(fs),readFileSyncUtilFS.apply(this,t)},readFileSyncUtilFS=function(e,t,i){var n=e.readFileSync(getRealOSPath(t));switch(i){case"text":return n.toString("utf8");case"json":return JSON.parse(n.toString("utf8"));default:return n}},createReadStream=function(e){return createReadStreamUtilFS(fs,e)},createReadStreamUtilFS=function(e,t){return e.createReadStream(getRealOSPath(t))},writeFile=function(e,t,i){return writeFileUtilFS(fs,e,t,i)},writeFileUtilFS=function(e,t,i,n){return suggestAsync(n,async(function(){if(!foundation.isKindOf(i,String)&&!foundation.isKindOf(i,Buffer)){if(foundation.isNull(i))return void this.reject(new Error("No content to write"));try{i=JSON.stringify(i)}catch(e){return void this.reject(e)}}e.writeFile(getRealOSPath(t),i,this.test)}))},writeFileSync=function(e,t){return writeFileSyncUtilFS(fs,e,t)},writeFileSyncUtilFS=function(e,t,i){if(!foundation.isKindOf(i,String)&&!foundation.isKindOf(i,Buffer)){if(foundation.isNull(i))throw new Error("No content to write");i=JSON.stringify(i)}e.writeFileSync(getRealOSPath(t),i)},createWriteStream=function(e){return createWriteStream(fs,e)},createWriteStreamUtilFS=function(e,t){return e.createWriteStream(getRealOSPath(t))},fileHash=function(e,t,i,n){return suggestAsync(n,async(function(){stream.getAllRestBuffer(createReadStreamUtilFS(t,i).pipe(crypto.createHash(e),{end:!0}),function(e,t){e?this.reject(e):this.next(t.toString("hex"))}.bind(this))}))},fileSHA1=function(e,t){return fileSHA1UtilFS(fs,e,t)},fileSHA1UtilFS=function(e,t,i){return fileHash("sha1",e,t,i)},fileSHA512=function(e,t){return fileSHA512UtilFS(fs,e,t)},fileSHA512UtilFS=function(e,t,i){return fileHash("sha512",e,t,i)},fileSHA256=function(e,t){return fileSHA256UtilFS(fs,e,t)},fileSHA256UtilFS=function(e,t,i){return fileHash("sha256",e,t,i)},fileMD5=function(e,t){return fileMD5UtilFS(fs,e,t)},fileMD5UtilFS=function(e,t,i){return fileHash("md5",e,t,i)},listFiles=function(e){return listFilesUtilFS(fs,e)},listFilesUtilFS=function(e,t){return e.readdirSync(getRealOSPath(t))},touchFile=function(e,t){return touchFileUtilFS(fs,e,t)},touchFileUtilFS=function(e,t,i){return suggestAsync(i,async(function(){fileExistsUtilFS(e,t)?this.next():writeFileUtilFS(e,t,"").pipe(this)}))},getFileURL=function(e){};module.exports={makeDir:makeDir,makeDirSync:makeDirSync,makeDirTree:foundation.deprecated("makeDirTree","makeDirs",makeDirs),makeDirs:makeDirs,makeDirsUtilFS:makeDirsUtilFS,makeDirsSyncUtilFS:makeDirsSyncUtilFS,copyFile:copyFile,copyFileUtilFS:copyFileUtilFS,copyFileSync:copyFileSync,copyFileSyncUtilFS:copyFileSyncUtilFS,deleteFile:deleteFile,deleteFileSync:deleteFileSync,deleteFiles:deleteFiles,deleteFilesUtilFS:deleteFilesUtilFS,deleteFilesSyncUtilFS:deleteFilesSyncUtilFS,scanFile:scanFile,scanFileUtilFS:scanFileUtilFS,scanFileSync:scanFileSync,scanFileSyncUtilFS:scanFileSyncUtilFS,linkFile:linkFile,linkFileUtilFS:linkFileUtilFS,linkFileSync:linkFileSync,linkFileSyncUtilFS:linkFileSyncUtilFS,lockFile:lockFile,lockFileUtilFS:lockFileUtilFS,getHomeDir:getHomeDir,getTempDir:getTempDir,getTempFile:getTempFile,isUnderDir:isUnderDir,getRealOSPath:getRealOSPath,getSimOSPath:getSimOSPath,getRealPath:getRealPath,getRealPathUtilFS:getRealPathUtilFS,watchFile:watchFile,watchFileUtilFS:watchFileUtilFS,getPathSeparator:getPathSeparator,standardizePath:standardizePath,ensurePosixPath:ensurePosixPath,resolvePath:resolvePath,resolveRootBasedPath:resolveRootBasedPath,getRelativePath:getRelativePath,isRootPath:isRootPath,isJustRootPath:isJustRootPath,fileExists:fileExists,fileExistsUtilFS:fileExistsUtilFS,dirExists:dirExists,dirExistsUtilFS:dirExistsUtilFS,onlyFileExists:onlyFileExists,onlyFileExistsUtilFS:onlyFileExistsUtilFS,tryToAccessFile:tryToAccessFile,tryToAccessFileUtilFS:tryToAccessFileUtilFS,isExecutable:isExecutable,isExecutableUtilFS:isExecutableUtilFS,getFileStats:getFileStats,getFileStatsUtilFS:getFileStatsUtilFS,getFileStatsSync:getFileStatsSync,getFileStatsSyncUtilFS:getFileStatsSyncUtilFS,setFileMode:setFileMode,setFileModeUtilFS:setFileModeUtilFS,setFileModeSync:setFileModeSync,setFileModeSyncUtilFS:setFileModeSyncUtilFS,listFiles:listFiles,listFilesUtilFS:listFilesUtilFS,getBasename:getBasename,getExtname:getExtname,getFilename:getFilename,getDirname:getDirname,changeExtname:changeExtname,appendBasename:appendBasename,getMime:getMime,readFile:readFile,readFileSync:readFileSync,readFileUtilFS:readFileUtilFS,readFileSyncUtilFS:readFileSyncUtilFS,writeFile:writeFile,writeFileSync:writeFileSync,writeFileUtilFS:writeFileUtilFS,writeFileSyncUtilFS:writeFileSyncUtilFS,createReadStream:createReadStream,createReadStreamUtilFS:createReadStreamUtilFS,createWriteStream:createWriteStream,createWriteStreamUtilFS:createWriteStreamUtilFS,changeRootPath:changeRootPath,moveFile:moveFile,moveFileSync:moveFileSync,moveFileUtilFS:moveFileUtilFS,moveFileSyncUtilFS:moveFileSyncUtilFS,fileMD5:fileMD5,fileMD5UtilFS:fileMD5UtilFS,fileSHA1:fileSHA1,fileSHA1UtilFS:fileSHA1UtilFS,fileSHA256:fileSHA256,fileSHA256UtilFS:fileSHA256UtilFS,fileSHA512:fileSHA512,fileSHA512UtilFS:fileSHA512UtilFS,touchFile:touchFile,touchFileUtilFS:touchFileUtilFS};