var async=require("./async.js"),timer=require("./timer.js"),home=require("./home.js"),fileLockObjects={},locks=new WeakMap,lockRecords={},nextLockID=1,lock=function(){var e=null,t=1/0,o=null;if(1===arguments.length)o=arguments[0];else if(2===arguments.length)"number"==typeof arguments[0]?t=Date.now()+arguments[0]:arguments[0]instanceof Date?t=arguments[0].getTime():e=arguments[0],o=arguments[1];else{if(e=arguments[0],"number"==typeof arguments[1])t=Date.now()+arguments[1];else{if(!(arguments[1]instanceof Date))throw new Error("Invalid timeout "+t);t=arguments[1].getTime()}o=arguments[2]}var c=home.getFileLine(1,0,!0),i=!1;e||(i=!0,fileLockObjects[c]||(fileLockObjects[c]={}),e=fileLockObjects[c]);var n={time:new Date,timeout:isFinite(t)?new Date(t):null,lockOnCode:i,fileLine:c,object:e,action:o,id:nextLockID};if(++nextLockID,lockRecords[n.id]=n,"function"!=typeof e&&"object"!=typeof e&&"symbol"!=typeof e)throw new Error("Target to synchronize must be a complex object");return locks.has(e)||locks.set(e,[]),async(function(){var c=this,i=!1,l=!1,r=null;t&&isFinite(t)&&(r=timer.plan(t,function(){i||(l=!0,c.reject(new Error("Sync timeout")))},"sync-timeout"));var s=locks.get(e);s.push(function(e){if(l)return delete lockRecords[n.id],void e();i=!0;var t=!0;r&&r.cancel();try{var s={release:function(){t&&(t=!1,delete lockRecords[n.id],e(),c.next.apply(c,arguments))},waive:function(o){t&&(t=!1,delete lockRecords[n.id],e(),c.reject(o))}};o.call(s,s.release,s.waive)}catch(o){if(!t)throw o;t=!1,delete lockRecords[n.id],e(),c.reject(o)}});var a=function(){s.length>0&&!s.acting&&(s.acting=!0,s.shift()(function(){timer.delay(function(){s.acting=!1,a()})}))};a()})},getLocks=function(){var e=new Map,t=[];return Object.keys(lockRecords).forEach(function(o){var c=lockRecords[o],i=null;e.has(c.object)?i=e.get(c.object):(i={actions:[]},c.lockOnCode?i.object=c.fileLine:i.object=c.object,t.push(i),e.set(c.object,i)),i.actions.push({fileLine:c.fileLine,time:c.time,timeout:c.timeout,action:c.action})}),t};lock.list=getLocks,module.exports={lock:lock,getLocks:getLocks};