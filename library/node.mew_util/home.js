var fs=require("fs"),path=require("path");if("js"!==process.arch)var vm=require("vm");var Module=require("module"),async=require("./async.js"),foundation=require("./foundation.js"),storage=require("./storage.js"),langWrap=null;try{langWrap=process.binding("lang_wrap")}catch(e){}var configCaches={},registeredConfigs={},utilHomeDir=null,getMewJSAPI=function(){return 0===parseInt(process.version.split(".")[0].replace(/[a-z]/gi,""))?0:1},getConfig=function(e,t,n){var i=getUtilFS(e);!configCaches.hasOwnProperty(e)||t?i.exists(e,function(t){t?i.stat(e,function(t,r){t?(configCaches[e]={},n(configCaches[e])):r.isFile()?i.readFile(e,function(t,i){if(t)configCaches[e]={};else try{configCaches[e]=JSON.parse(i.toString("utf8"))}catch(t){configCaches[e]={}}n(configCaches[e])}):(configCaches[e]={},n(configCaches[e]))}):(configCaches[e]={},n(configCaches[e]))}):n(configCaches[e])},getConfigSync=function(e,t){var n=getUtilFS(e);if(!configCaches.hasOwnProperty(e)||t)try{n.existsSync(e)&&n.statSync(e).isFile()?configCaches[e]=JSON.parse(n.readFileSync(e).toString("utf8")):configCaches[e]={}}catch(t){configCaches[e]={}}return configCaches[e]},getUtilHomeDir=function(e){return e?utilHomeDir?path.resolve(utilHomeDir,e):path.resolve(process.cwd(),e):utilHomeDir||process.cwd()},setUtilHomeDir=function(e,t){utilHomeDir=e;var n=0,i=function(){n<registeredConfigs.length?getUtilConfig(registeredConfigs[++n-1],null,i):t()};i()},getUtilConfig=function(e,t){t||(t=registeredConfigs[e]);var n=foundation.copyAsArray(arguments).slice(2),i=function(){};foundation.isKindOf(n[n.length-1],Function)&&(i=n.pop());var r=storage.getRealOSPath(storage.resolvePath(storage.getHomeDir(".mew/conf"),e+".json")),o=storage.getRealOSPath(storage.resolvePath(getUtilHomeDir("conf"),e+".json"));getConfig(r,t["!noCache"],function(e){n.unshift(e),r!==o?getConfig(o,t["!noCache"],function(e){n.unshift(e),n.unshift(t),i(foundation.advancedMerge.apply(foundation,n))}):(n.unshift(t),i(foundation.advancedMerge.apply(foundation,n)))})},getUtilConfigSync=function(e,t){t||(t=registeredConfigs[e]);var n=foundation.copyAsArray(arguments).slice(2),i=storage.getRealOSPath(storage.resolvePath(storage.getHomeDir(".mew/conf"),e+".json")),r=storage.getRealOSPath(storage.resolvePath(getUtilHomeDir("conf"),e+".json"));return n.unshift(getConfigSync(i,t["!noCache"])),i!==r&&n.unshift(getConfigSync(r,t["!noCache"])),n.unshift(t),foundation.advancedMerge.apply(foundation,n)},mergeConfig=function(e,t){return foundation.advancedMerge(registeredConfigs[e],t)},registerUtilConfig=function(e,t){registeredConfigs.hasOwnProperty(e)||(registeredConfigs[e]=t)},fses={},requires={},registerUtilFS=function(e,t,n){var i=path.resolve(e);fses[i]=t,n&&(requires[i]=n)},getUtilFS=function(e){e=path.resolve(e);var t=null;return Object.keys(fses).forEach(function(n){e!==n&&0!==e.indexOf(n+path.sep)||(!t||t.length<n.length)&&(t=n)}),t?fses[t]:fs},requireModule=function(e,t){var n=resolveModule(e,t);if(n){var i=null;return Object.keys(requires).forEach(function(e){n!==e&&0!==n.indexOf(e+path.sep)||(!i||i.length<e.length)&&(i=e)}),i?requires[i](n):e.require(n)}throw new Error("Module not found: "+t)},resolveAsCoreModules=function(e,t,n){if(-1!==["child_process","cluster","crypto","debugger","dgram","dns","domain","events","fs","http","https","module","net","os","path","process","punycode","querystring","readline","repl","smalloc","stream","string_decoder","timers","tls","tty","url","util","vm","v8","zlib","sqlite3","mew_util","mewchan","mew_java","mew_android","mew_objc","mew_ios"].indexOf(n))return n},resolveAsFile=function(e,t,n){return e.existsSync(n)&&e.statSync(n).isFile()?n:e.existsSync(n+".js")&&e.statSync(n+".js").isFile()?n+".js":e.existsSync(n+".json")&&e.statSync(n+".json").isFile()?n+".json":e.existsSync(n+".chan")&&e.statSync(n+".chan").isFile()?n+".chan":e.existsSync(n+".node")&&e.statSync(n+".node").isFile()?n+".node":void 0},resolveAsDirectory=function(e,t,n){var i=!1;if(e.existsSync(n+"/package.json")){var r=JSON.parse(e.readFileSync(n+"/package.json").toString("utf8")).main;if(r){if(r=path.normalize(path.join(n,r)),e.existsSync(r)&&e.statSync(r).isFile())return r;i=!0,global["@warn"]&&global["@warn"]("Incorrect package json file found, main script file does not exists: "+r)}else i=!0,global["@warn"]&&global["@warn"]("Incorrect package json file found, no main script file recorded")}return e.existsSync(n+"/index.js")?(i&&global["@warn"]&&global["@warn"]("Try to use index.js as main script file"),path.normalize(n+"/index.js")):e.existsSync(n+"/index.json")?(i&&global["@warn"]&&global["@warn"]("Try to use index.json as main script file"),path.normalize(n+"/index.json")):e.existsSync(n+"/index.chan")?(i&&global["@warn"]&&global["@warn"]("Try to use index.chan as main script file"),path.normalize(n+"/index.chan")):e.existsSync(n+"/index.node")?(i&&global["@warn"]&&global["@warn"]("Try to use index.node as main script file"),path.normalize(n+"/index.node")):void 0},resolveAsNodeModules=function(e,t,n){for(var i=null,r=0;r<t.paths.length;){if(i=resolveAsFile(e,t,path.normalize(path.join(t.paths[r],n))))return i;if(i=resolveAsDirectory(e,t,path.normalize(path.join(t.paths[r],n))))return i;++r}},resolveModule=function(e,t){t=/^\.(\.?)[\\\/]/.test(t)?path.normalize(path.join(path.dirname(e.id),t)):path.normalize(t);var n=null;n=getUtilFS(storage.isRootPath(t)?t:e.id);var i=path.basename(t),r=".mew-js"===path.extname(t);r&&(t=t.slice(0,t.length-i.length)+i.split(".").slice(0,-2).join(".")+".js");var o=resolveAsCoreModules(n,e,t);return o||(storage.isRootPath(t)?(o=resolveAsFile(n,e,t))||(o=resolveAsDirectory(n,e,t)):o=resolveAsNodeModules(n,e,t)),o?r?path.join(path.dirname(o),i):o:null},mewJSes={},registerMewJS=function(e,t){mewJSes[e]=foundation.merge(mewJSes[e],t)},getMewJSInfo=function(){var e=null;if(e=0===arguments.length?storage.standardizePath(getFileLine(1,0).split(":").slice(0,-1).join(":")):foundation.isKindOf(arguments[0],Number)?storage.standardizePath(getFileLine(offset+1,0).split(":").slice(0,-1).join(":")):arguments[0],".mew-js"===path.extname(e)){var t=e.split(".").slice(-2)[0];return mewJSes[t]}return null},getFileLine=function(e,t,n,i,r){if(langWrap){i||(i=function(){return!0}),void 0===r&&(r=4);try{var o=langWrap.getFileLine(e+1,r,i),a=o[0].split(path.sep).slice(-t).join(path.sep)+":"+o[1];return n&&(a+=":"+o[2]),a}catch(e){return"win32"===process.platform?"C:\\Temporary\\UnknownFile:0"+(n?":0":""):"/tmp/unknown-file:0"+(n?":0":"")}}else{var s=(new Error).stack;if(!s)return"win32"===process.platform?"C:\\Temporary\\UnknownFile:0"+(n?":0":""):"/tmp/unknown-file:0"+(n?":0":"");try{var l="@";return"V8"===foundation.getScriptEngineName()&&(++e,l="at"),foundation.isKindOf(t,Number)||(t=0),")"===(a=s.split("\n")[e+1].split(l).slice(1).join(l).trim())[a.length-1]&&(a=a.slice(a.indexOf("(")+1,-1)),0!==t&&/^[a-z]+:\/\//.test(a)&&(a=a.split(/\/+/).slice(2).join("/")),t=a.split(path.sep).slice(-t).join(path.sep).split(":"),t=[t.slice(0,t.length-2).join(":"),t[t.length-2],t[t.length-1]],n?t.join(":").trim():t.slice(0,t.length-1).join(":").trim()}catch(e){return"win32"===process.platform?"C:\\Temporary\\UnknownFile:0"+(n?":0":""):"/tmp/unknown-file:0"+(n?":0":"")}}};require("module")._extensions[".mew-js"]=function(e,t,n){var i=path.normalize(path.join(path.dirname(t),path.basename(t).split(".").slice(0,-2).join(".")+".js")),r=fs.readFileSync(i,"utf8");65279===r.charCodeAt(0)&&(r=r.slice(1));try{e._compile(r,t,void 0,void 0)}catch(e){throw global["@error"]&&global["@error"]("Failed to compile file "+t),e}};var evaluateScript=function(e,t,n){var i={};for(var r in global)i[r]=global[r];return i.require=n||module.require,i.exports={},i.__filename=t,i.filename=t,i.__dirname=path.dirname(t),i.dirname=path.dirname(t),i.module=i,i.global=global,vm.runInThisContext(n("module").wrap(e),{filename:t}).call(i.exports,i.exports,i.require,i,i.__filename,i.__dirname,global.setTimeout,global.setInterval,global.process),i},refHandler={has:function(e,t){return!e.isGCed()&&t in e.getTarget()},get:function(e,t,n){if(e.isGCed()){if("@gced"===t)return!0}else{if("@"!==t[0]){var i=e.getTarget()[t];return foundation.isKindOf(i,Function)?function(){if(this===n){if(e.isGCed())throw new Error("Target has already been GCed");return i.apply(e.getTarget(),arguments)}return i.apply(this,arguments)}:i}if("@target"===t)return e.getTarget();if("@gced"===t)return!1}},set:function(e,t,n,i){return!e.isGCed()&&(e.getTarget()[t]=n,!0)},defineProperty:function(e,t,n){if(e.isGCed())return!1;Object.defineProperty(e.getTarget(),t,n)},deleteProperty:function(e,t){return!e.isGCed()&&delete e.getTarget()[t]},ownKeys:function(e){return e.isGCed()?[]:Object.getOwnPropertyNames(e.getTarget())},getOwnPropertyDescriptor:function(e,t){return e.isGCed()?void 0:Object.getOwnPropertyDescriptor(e.getTarget(),t)},getPrototypeOf:function(e){return e.isGCed()?Object.prototype:Object.getPrototypeOf(e.getTarget())}},makeWeakRef=function(e,t){t||(t=function(){});var n=langWrap.makeWeakRef(e,t);return new Proxy(n,refHandler)},WeakRefMap=function(){var e=new Map;Object.defineProperty(this,"size",{get:function(){return e.size}});var t=function(t){return function(){e.delete(t)}};this.get=function(t){var n=e.get(t);return n?n["@target"]:void 0},this.clear=function(){e.clear()},this.delete=function(t){e.delete(t)},this.entries=function(){var t=e.entries();return{next:function(){var e=t.next();return e.done?{done:!0}:{done:!1,value:[e.value[0],e.value[1]["@target"]]}}}},this.forEach=function(t,n){e.forEach(function(n,i){t.call(this,n["@target"],i,e)},n)},this.has=function(t){return e.has(t)},this.keys=function(){return e.keys()},this.set=function(n,i){e.set(n,makeWeakRef(i,t(n)))},this.values=function(){return e.values().map(function(e){return e["@target"]})}},gc=function(){langWrap.gc()};global.WeakRefMap=WeakRefMap,module.exports={getConfig:getConfig,getConfigSync:getConfigSync,getUtilHomeDir:getUtilHomeDir,setUtilHomeDir:setUtilHomeDir,getUtilConfig:getUtilConfig,getUtilConfigSync:getUtilConfigSync,mergeConfig:mergeConfig,registerUtilConfig:registerUtilConfig,registerUtilFS:registerUtilFS,getUtilFS:getUtilFS,requireModule:requireModule,resolveModule:resolveModule,registerMewJS:registerMewJS,getMewJSInfo:getMewJSInfo,getFileLine:getFileLine,evaluateScript:evaluateScript,getMewJSAPI:getMewJSAPI,makeWeakRef:makeWeakRef,gc:gc};