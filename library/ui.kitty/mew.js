var mewUtil=require("mew_util"),Content=require("./content.js"),Play=require("./play.js"),WAITING="waiting",HELD="held",TIMEOUT="timeout",FOLLOWING="following",FOLLOWED="followed",RELEASED="released",MEW_URGE="mew.urge",MEW_COMPLEMENT="mew.complement",MEW_CANCEL="mew.cancel",MEW_PROMISE="mew.promise",MEW_HOLD="mew.hold",MEW_RELEASE="mew.release",MEW_TIMEOUT="mew.timeout",Mew=function(e,t,o,i,n,r){Object.defineProperty(this,"mewchan",{enumerable:!1,value:e}),this.id=r?r.id:null,this.id||(this.id=mewUtil.createUUID()),this.from=t,this.play=Play.ensure(o),this.usage=i,this.content=Content.ensure(n),Object.defineProperty(this,"options",{enumerable:!1,value:mewUtil.advancedMerge({timeout:{"!valueType":"number","!defaultValue":3e4},holdTimeout:{"!valueType":"number"},minHoldTimeout:{"!valueType":"number","!defaultValue":0}},r||{})}),mewUtil.isKindOf(this.options.holdTimeout,Number)||(this.options.holdTimeout=this.options.timeout/20),this.options.holdTimeout<this.options.minHoldTimeout&&(this.options.holdTimeout=this.options.minHoldTimeout),this.options.timeout<this.options.holdTimeout&&(this.options.holdTimeout=this.options.timeout),this.options.expiredDate=(new Date).getTime()+this.options.timeout,this.options.holdExpiredDate=(new Date).getTime()+this.options.holdTimeout,Object.defineProperty(this,"manager",{enumerable:!1,value:new MewManager(this)}),Object.defineProperty(this,"sender",{enumerable:!1,value:new MewSender(this)}),this.elder=e.findElder(this),["repliedActions","amendedActions","replies","amends"].forEach(function(e){Object.defineProperty(this,e,{enumerable:!1,value:[]})}.bind(this)),Object.defineProperty(this,"snapshot",{enumerable:!1,value:new MewSnapshot(this)}),this.state=WAITING};Mew.prototype.elderDetermined=!1,Mew.prototype.reply=function(e){var t=(new Date).getTime()>this.options.expiredDate;t&&0===this.replies.length&&(t=!1),t?(this.amends.push(e),this.amendedActions.forEach(function(t){try{t.call({},e.snapshot)}catch(e){mewUtil.delay(function(){throw e})}})):(this.replies.push(e),this.repliedActions.forEach(function(t){try{t.call({},e.snapshot)}catch(e){mewUtil.delay(function(){throw e})}}))},Mew.prototype.hold=function(e,t,o,i){var n=this,r=HELD,l=[];t&&l.push(t);var s=null,a=mewUtil.createUUID();if(this.state===HELD||this.state===WAITING){var h=(new Date).getTime();(void 0===e||null===e||h+e>this.options.expiredDate)&&(e=this.options.expiredDate-h);var p=this.options.holdExpiredDate;this.state===WAITING?this.state=HELD:p=this.options.expiredDate,h<p?(s=mewUtil.delay(e,function(){s=null;var e=l;l=[],r!==HELD&&r!==FOLLOWING||(r=TIMEOUT,e.forEach(function(e){e.call({follow:u,release:m})}))}),n.mewchan.mew(o,n.play,MEW_HOLD,null,{id:a,follow:n})):void 0!==e&&null!==e&&(r=TIMEOUT)}var u=function(e,t,h){if(s&&(s.cancel(),s=null),l=[],r===FOLLOWING||i){r=FOLLOWED,(h=mewUtil.merge({},h)).follow=n;var p=n.mewchan.mew(o,n.play,e,t,h);return i||n.mewchan.mew(o,n.play,MEW_RELEASE,null,{hold:a,follow:n}),p}if(r!==TIMEOUT)throw new Error("Duplicated reactios is not allowed for one hold");var d=l;l=[],d.forEach(function(e){e.call({follow:u,release:m})})},m=function(){if(s&&(s.cancel(),s=null),l=[],r===FOLLOWING||i)return r=RELEASED,n.mewchan.mew(o,n.play,MEW_RELEASE,null,{hold:a,follow:n});throw new Error("Duplicated reactions is not allowed for one hold")},d={then:function(e){if(r===HELD){r=FOLLOWING;try{e.call({follow:u,release:m})}catch(e){mewUtil.delay(function(){throw e})}}else if(r!==TIMEOUT)throw new Error("Only one then action could be set currently");return d},timeout:function(e){return r===TIMEOUT?e.call({follow:u,release:m}):r!==HELD&&r!==FOLLOWING||l.push(e),d}};return d},Mew.prototype.wrap=function(e){return new MewWrapped(this,e)},Mew.prototype.followed=function(e){if(this.elderDetermined||this.state!==WAITING)throw new Error("Elder has been choosen for the mew");return Object.defineProperty(this,"elderDetermined",{enumerable:!1,value:!0}),this.elder=e,this},Mew.prototype.replied=function(e){return this.repliedActions.push(e),this.replies.slice(0).forEach(function(t){e.call({},t)}),this},Mew.prototype.amended=function(e){return this.amendedActions.push(e),this.amends.slice(0).forEach(function(t){e.call({},t)}),this},Mew.prototype.then=function(e){return e.call(this,this.sender),this},Mew.prototype.urge=function(e,t){return(t=mewUtil.merge({},t)).follow=this,this.mewchan.mew(this.from,this.play,MEW_URGE,e,t)},Mew.prototype.complement=function(e,t){return(t=mewUtil.merge({},t)).follow=this,this.mewchan.mew(this.from,this.play,MEW_COMPLEMENT,e,t)},Mew.prototype.cancel=function(e,t){return(t=mewUtil.merge({},t)).follow=this,this.mewchan.mew(this.from,this.play,MEW_CANCEL,e,t)},Object.defineProperty(Mew.prototype,"getContent",{enumerable:!1,value:function(){for(var e=this,t=Object.keys(this.content),o=0;o<arguments.length;){var i=arguments[o];if(this.content.hasOwnProperty(i))return mewUtil.async(function(){this.next(i,e.content[i])});if(this.mewchan.interpreters.hasOwnProperty(i))for(var n=0;n<t.length;){if(this.mewchan.interpreters[i].hasOwnProperty(t[n]))return(e=this).mewchan.interpreters[i][t[n]](e.content[t[n]]).then(function(e){this.next(i,e)});++n}++o}return mewUtil.async.reject(new Error("No data matched preferred types"))}});var MewSender=function(e){var t=this;Object.defineProperty(this,"mewchan",{enumerable:!1,value:e.mewchan.agent}),this.id=e.id,this.from=e.from,this.play=Play.getClosure(e.play,e.from),this.usage=e.usage,this.content=e.content,Object.defineProperty(this,"options",{enumerable:!1,value:{follow:e.options.follow?e.options.follow.snapshot:null,reply:e.options.reply?e.options.reply.snapshot:null,requireReply:e.options.requireReply,holdTimeout:e.options.holdTimeout,holdExpiredDate:e.options.holdExpiredDate,timeout:e.options.timeout,expiredDate:e.options.expiredDate}}),Object.defineProperty(this,"snapshot",{enumerable:!1,get:function(){return e.snapshot}}),["urge","complement","cancel","getContent"].forEach(function(o){Object.defineProperty(t,o,{enumerable:!1,value:function(){return e[o].apply(e,arguments),t}})}),Object.defineProperty(this,"time",{enumerable:!0,get:function(){return e.time}})},MewManager=function(e){var t=this;Object.defineProperty(this,"mewchan",{enumerable:!1,value:e.mewchan.agent}),this.id=e.id,this.from=e.from,this.play=Play.getClosure(e.play,e.from),this.usage=e.usage,this.content=e.content,Object.defineProperty(this,"options",{enumerable:!1,value:{follow:e.options.follow?e.options.follow.snapshot:null,reply:e.options.reply?e.options.reply.snapshot:null,requireReply:e.options.requireReply,holdTimeout:e.options.holdTimeout,holdExpiredDate:e.options.holdExpiredDate,timeout:e.options.timeout,expiredDate:e.options.expiredDate}}),Object.defineProperty(this,"snapshot",{enumerable:!1,get:function(){return e.snapshot}}),["followed","replied","amended","then","getContent"].forEach(function(o){Object.defineProperty(t,o,{enumerable:!1,configurable:!0,value:function(){return e[o].apply(e,arguments),t}})}),Object.defineProperty(this,"time",{enumerable:!0,get:function(){return e.time}})},MewWrapped=function(e,t){Object.defineProperty(this,"mewchan",{enumerable:!1,value:e.mewchan.agent}),Object.defineProperty(this,"snapshot",{enumerable:!1,get:function(){return e.snapshot}}),this.id=e.id,this.from=e.from,this.play=Play.getClosure(e.play,t),this.usage=e.usage,this.content=e.content,Object.defineProperty(this,"options",{enumerable:!1,value:{follow:e.options.follow?e.options.follow.snapshot:null,reply:e.options.reply?e.options.reply.snapshot:null,requireReply:e.options.requireReply,holdTimeout:e.options.holdTimeout,holdExpiredDate:e.options.holdExpiredDate,timeout:e.options.timeout,expiredDate:e.options.expiredDate}}),Object.defineProperty(this,"getContent",{enumerable:!1,value:e.getContent.bind(e)}),Object.defineProperty(this,"hold",{enumerable:!1,value:function(){var o=void 0,i=void 0;return mewUtil.isKindOf(arguments[0],Number)&&(o=arguments[0]),mewUtil.isKindOf(arguments[0],Function)?i=arguments[0]:mewUtil.isKindOf(arguments[1],Function)&&(i=arguments[1]),e.hold(o,i,t,!1)}}),Object.defineProperty(this.hold,"thread",{enumerable:!1,value:function(){var o=void 0,i=void 0;return mewUtil.isKindOf(arguments[0],Number)&&(o=arguments[0]),mewUtil.isKindOf(arguments[0],Function)?i=arguments[0]:mewUtil.isKindOf(arguments[1],Function)&&(i=arguments[1]),e.hold(o,i,t,!0)}}),Object.defineProperty(this,"time",{enumerable:!0,get:function(){return e.time}})},MewSnapshot=function(e){this.id=e.id,Object.defineProperty(this,"mewchan",{enumerable:!1,value:e.mewchan.agent}),this.from=e.from,this.play=Play.getClosure(e.play,"mewchan.snapshot"),this.usage=e.usage,this.content=e.content,Object.defineProperty(this,"options",{enumerable:!1,value:{follow:e.options.follow?e.options.follow.snapshot:null,reply:e.options.reply?e.options.reply.snapshot:null,requireReply:e.options.requireReply,holdTimeout:e.options.holdTimeout,holdExpiredDate:e.options.holdExpiredDate,timeout:e.options.timeout,expiredDate:e.options.expiredDate}}),Object.defineProperty(this,"getContent",{enumerable:!1,value:e.getContent.bind(e)}),Object.defineProperty(this,"snapshot",{enumerable:!1,value:this}),Object.defineProperty(this,"time",{enumerable:!0,get:function(){return e.time}})};module.exports=Mew;