var os=require("os"),mewUtil=require("mew_util"),Mewchan=require("./mewchan.js"),Requester=null,basePath=".",$=null;global.window===global?(Requester=require("./browser.js"),$=global.$):(Requester=require("./node.js"),basePath="../..",$=global["@"]);var Play=require(basePath+"/play.js"),Content=require(basePath+"/content.js"),Mew=require(basePath+"/mew.js"),kittyURL=null;global&&global.document&&global.document.URL&&(kittyURL=global.document.URL);var listenerTypes=["connection.reset","connection.amend","connection.disconnected","connection-offline","connection-online"],Kitty=function(e){var t=this;e=$.merge.advanced({uri:{"!aliasField":"url"},url:{"!valueType":"string","!defaultValue":"/kitty.ui"},name:{"!defaultValue":"kitty.ui","!valueType":"string"},path:{"!defaultValue":kittyURL,"!valueType":"string"},domain:{"!defaultValue":"cn.mewmew.kitty.ui","!valueType":"string"},author:{"!defaultValue":"anonymous","!valueType":"string"},description:{"!defaultValue":"A wild kitty appeared","!valueType":"string"},version:{"!defaultValue":"0.1.0","!valueType":"string"},company:{"!valueType":"string"},website:{"!defaultValue":kittyURL,"!valueType":"string"},holdTimeout:{"!defaultValue":1e3,"!valueType":"number"},logLevel:{"!defaultValue":"info","!valueType":"string"},autorestatement:{"!defaultValue":!0,"!valueType":"boolean"},logStyle:{"!valueType":"string","!defaultValue":process.isEmbedded||global.window&&global.window.navigator?"none":"darwin"===os.type().toLowerCase()?"bright":"dark"}},e),this.logger=$.logger({logLevel:e.logLevel,logStyle:e.logStyle}),this.name=e.name,this.path=e.path,this.play={},this.memories={},this.data={},this.url=e.url,this.domain=e.domain,this.author=e.author,this.description=e.description,this.version=e.version,this.company=e.company,this.website=e.website,this.holdTimeout=e.holdTimeout,this.listeners={},listenerTypes.forEach(function(e){t.listeners[e]=[]}),this.token=null,this.disconnected=!1,this.autorestatement=e.autorestatement,this.requester=new Requester(this.path);var n=new Mewchan(this,function(e,n,o,i,a,s){var c=d(e,n,o,i,$.merge({holdTimeout:t.holdTimeout},a));return r.push({id:c.id,from:e,play:Play.getCommonData(c.play),usage:c.usage,content:Content.unwrap(c.content),options:c.options,callback:function(e){s?s.call(this,e,c):e&&t.logger.error(e)}}),l(),c}),o=function(e){var n=e.getResponseHeader("Mew-Token");if(n){var o=t.token;t.token=n,o||l()}},r=[],i=!1,l=function(){i||!t.token||t.disconnected||(i=!0,process.nextTick(function(){var e={},n=r.map(function(t){e[t.id]=t.callback;var n=t.options.follow;n&&n.hasOwnProperty("id")&&n.id&&(n=n.id);var o=t.options.reply;return o&&o.hasOwnProperty("id")&&o.id&&(o=o.id),{play:t.play,usage:t.usage,content:t.content,options:{id:t.id,requireReply:t.options.requireReply,hold:t.options.hold,follow:n,reply:o,timeout:t.options.timeout,holdTimeout:t.options.holdTimeout}}});r=[],i=!1,n.length>0&&t.requester.request("POST",t.url,n,{async:!0,headers:{"Mew-Token":t.token||""},responseDataType:"json",requestDataType:"json",timeout:3e4},function(n,r,i){n?(t.logger.error(n),Object.keys(e).forEach(function(o){if(e[o])try{e[o](n)}catch(e){t.logger.error(e)}})):(o(i),Object.keys(r.results).forEach(function(t){e[t]&&("success"===r.results[t].status?e[t](null):e[t](new Error("Server refused")))}))})}))},a=0,s=[-1,0,100,200,400,800,1600,3200,6400],c=!0,u=!1,f=function(){u||t.disconnected||(u=!0,t.requester.request("GET",t.url,null,{async:!0,headers:{"Mew-Token":t.token||""},responseDataType:"json",requestDataType:"json",timeout:3e4},function(r,i,l){u=!1,r&&!r.causedByTimeout?(a||(t.logger.warn(`Kitty [${e.url}] offline`),t.emit("connection-offline")),++a):((a||c)&&(c=!1,t.logger.info(`Kitty [${e.url}] online`),t.emit("connection-online")),a=0),r||(o(l),i.forEach(function(e){if("@"===e.usage.charAt(0))switch(e.usage){case"@connection.reset":t.autorestatement&&t.restatement(),t.emit("connection.reset",e);break;case"@connection.amend":switch(e.content["@connection.amend"].action){case"mew.markAsReply":p.put($.uuid(),e)}t.emit("connection.amend",e)}else try{if((e=d(e.from,e.play,e.usage,e.content,e.options)).options.follow&&e.options.follow.elder)try{e.options.follow.elder.call({reply:function(){if(1===arguments.length){var o=arguments[0];return e.options.follow.reply(o.snapshot),n.mew(t.name,null,"@mew.reply",{"!content":!0,"@mew.reply":{mew:e.options.follow.id,reply:o.id}}),o}var r=arguments[0],i=arguments[1],l=arguments[2],a=arguments[3];return(a=$.merge.simple({},a)).reply=e.options.follow,o=e.mewchan.mew(r,e.play,i,l,a)}},e.wrap("mewchan.elder"))}catch(e){t.logger.error(e),$.delay(function(){throw e})}e.options.reply&&e.options.reply.reply(e);var o=[];Object.keys(g).filter(function(t){var n=g[t];return!!n.listener&&$.format.run(n.rule,n.compiled,$.merge.simple(n.presetData,{mew:{from:e.from,usage:e.usage,play:Play.getCommonData(e.play)}}),{functors:{satisfy:function(e,t,n,o,r,i){return r.filter(function(e){return"*"===e||i.split(".").filter(function(t,n,o){if(n!==o.length-1){if(o.slice(0,n+1).join(".")+".*"===e)return!0}else if(i===e)return!0;return!1}).length>0}).length>0}}})}).forEach(function(e){var t=g[e];t.listener&&-1===o.indexOf(t.listener)&&o.push(t.listener)}),o.forEach(function(n){try{n(e)}catch(e){t.logger.error(e)}})}catch(e){t.logger.error(e)}}),p.clearExpired(),p.keys().forEach(function(e){var t=p.get(e),n=h.get(t.options.reply,!0),o=h.get(t.options.follow,!0);n&&o&&(o.reply(n),p.remove(e))}));var m=s[a];a>=s.length&&(m=s[s.length-1]),$.delay(m,function(){f()})}))};f();var h=$.memory.cachePool(6e4),p=$.memory.cachePool(6e4),d=function(e,t,o,r,i){var l=null;if(i&&i.id?l=h.get(i.id,!0,function(){return new Mew(n,e,t,o,r,i)}):(l=new Mew(n,e,t,o,r,i),h.put(l.id,l)),i){var a=i.follow;a&&a.id&&(a=a.id),a&&(l.options.follow=h.get(a,!0));var s=i.reply;s&&s.id&&(s=s.id),s&&(l.options.reply=h.get(s,!0))}return l},m=function(e,o,r,i,l){var a=n.mew(t.name,e,o,r,i,l||function(e){e&&t.logger.error(e)}).manager,s=a.followed;return Object.defineProperty(a,"followed",{enumerable:!1,configurable:!0,value:function(){return n.mew(t.name,null,"@mew.followed",{"!content":!0,"@mew.followed":{id:a.id}}),s.apply(this,arguments)}}),a};this.mew=function(e,n,o,r){return e||(e=t.play),m(e,n,o,r)},this.mew.auto=function(){var e=null,n=null,o=null,r=null;if($.is(arguments[0],String)?(n=arguments[0],o=arguments[1],r=arguments[2]):(e=arguments[0],n=arguments[1],o=arguments[2],r=arguments[3]),e||(e=t.play),null!==o&&void 0!==o&&!$.is(o,Content)&&!o["!content"]){var i={"!content":!0};i[n]=o,o=i}return t.mew(e,n,o,r)},this.mew.rpc=function(){var e=null,n=null,o=null,r=null;if($.is(arguments[0],String)?(n=arguments[0],o=arguments[1],r=arguments[2]):(e=arguments[0],n=arguments[1],o=arguments[2],r=arguments[3]),e||(e=t.play),null!==o&&void 0!==o&&!$.is(o,Content)&&!o["!content"]){var i={"!content":!0};i["rpc.call."+n]=o,o=i}var l,a=m(e,"rpc.call."+n,o,$.merge({requireReply:!0},r||{}),function(e){e&&l&&l(e)});return Object.defineProperty(a,"replied",{enumerable:!1,value:function(e){return function(t){return l=t,e.call(this,function(e){e.content.hasOwnProperty("mew.exception")?t.call(this,e.content["mew.exception"],null,e):"mew.ignore"===e.usage?t.call(this,new Error("Mew RPC procedure ["+n+"] has been ignored by kitties"),null,e):"mew.timeout"===e.usage?t.call(this,new Error("Mew RPC procedure ["+n+"] has been timeout"),null,e):t.call(this,null,e.content["rpc.reply."+n],e)})}}(a.replied)}),a};var y={};this.heard=function(e,n){var o=[],r=[];arguments.length>1?(e=[arguments[0]].join(" "),n=[arguments[1]].join(" ")):(e="*",n=[arguments[0]].join(" ")),e.toString().split(/[,\s]/g).forEach(function(e){(e=e.trim()).length>0&&-1===o.indexOf(e)&&o.push(e)}),n.toString().split(/[,\s]/g).forEach(function(e){(e=e.trim()).length>0&&-1===r.indexOf(e)&&r.push(e)});var i=[];o.forEach(function(e){r.forEach(function(t){y.hasOwnProperty(e)||(y[e]={}),y[e].hasOwnProperty(t)||(y[e][t]=[]),y[e][t].push(i)})});var l=$.uuid(),a={then:function(e){return i.push(e),a},handle:function(e){return e(l),a}};return t.interest({id:l,rule:"satisfy(usages, mew.usage) && satisfy(friends, mew.from)",presetData:{usages:r,friends:o},listener:function(e){i.forEach(function(n){try{n.call({},e.wrap(t.name))}catch(e){t.logger.error(e)}})}}),a},this.heard.hold=function(e,n){var o=null,r=null;t.heard(e,n).handle(function(e){o=e}).then(function(e){e.hold().then(function(){r.call(this,e)})});var i={handle:function(e){return e(o),i},then:function(e){if(r)throw new Error("Only one then could be followed currently");return r=e,i}};return i},this.heard.redirect=function(e,n,o){t.heard(e,n).then(function(e){var n=$.format(o.usage,{mew:e,kitty:t},{functors:o.functors}),r={"!content":!0};Object.keys(o.content).forEach(function(n){var i="copy",l=o.content[n];$.is(l,String)?(i=l,l={}):$.is(l,Object)&&l["!action"]&&(i=l["!action"]);var a=l["!sourceType"];if(a||(a=n),!$.is.nil(e.content[a])||!1===l["!omitNullContent"])switch(i){case"copy":r[n]=e.content[a];break;case"map":var s={};Object.keys(l).forEach(function(n){if("!"!==n[0]){var r=s;n.split(".").forEach(function(i,s,c){if(s<c.length-1)r.hasOwnProperty(i)||(r[i]={}),r=r[i];else{var u=e.content[a];$.format(l[n],{mew:e,kitty:t,content:u},{functors:o.functors}).split(".").forEach(function(e,t,n){$.is.nil(u)||(u=u[e])}),r[i]=u}})}}),r[n]=s;break;case"template":r[n]=$.format.execute(l["!template"],{mew:e,kitty:t,content:e.content[a]},{functors:o.functors});break;case"merge":e.content[a];r[n]=$.merge.advanced(l["!options"],e.content[a]);break;default:throw new Error("Invalid action for mew redirection")}}),t.mew(e.play,n,r,{holdTimeout:e.options.holdExpiredDate-(new Date).getTime(),timeout:e.options.expiredDate-(new Date).getTime(),requireReply:o.requireReply})})},this.heard.rpc=function(){var e=null,n=null;arguments.length>1?(e=[arguments[0]].join(" "),n=[arguments[1]].join(" ")):(e="*",n=[arguments[0]].join(" "));var o=null;t.heard(e,n.split(/[,\s]+/).map(function(e){return e?"rpc.call."+e.trim():""}).filter(function(e){return e&&e.length>0}).join(" ")).then(function(e){e.hold().then(function(){var t=this,n=e.usage.split(".").slice(2).join("."),r=function(e,t){e?i.error(e):i.reply(t)},i={reply:function(e){if(!($.is(e,Content)||e&&e["!content"])){var o={"!content":!0};o["rpc.reply."+n]=e,e=o}t.follow("rpc.reply."+n,e)},error:function(e){$.is(e,Content)||e&&e["!content"]||($.is(e,String)&&(e=new Error(e)),$.is(e,Error)?e={"!content":!0,"mew.exception":{message:e.message,stack:e.stack}}:e&&e["!content"]||(e={"!content":!0,"mew.exception":e})),t.follow("rpc.reply."+n,e)}};try{var l;(l=o.length<=1?o.call(i,e.content["rpc.call."+n]):o.call(i,n,e.content["rpc.call."+n],r,e))&&$.async.isAsync(l)&&l.then(function(e){r(null,e)}).rejected(function(e){r(e)})}catch(e){r(e)}})});var r={then:function(e){if(o)throw new Error("Only one then could be followed currently");return o=e,r}};return r};var g={};this.interest=function(){for(var e=[],o=0;o<arguments.length;){var r=arguments[o];$.is(arguments[o],String)&&(r={rule:r}),r.id||(r.id=$.uuid()),r.compiled||(r.compiled=$.format.compile(r.rule,{})),g[r.id]=r,e.push({id:r.id,rule:r.rule,presetData:r.presetData}),++o}e.length>0&&n.mew(t.name,null,"@mew.interest",{"!content":!0,"@mew.interest":e})},this.ignore=function(){for(var e=[],o=0;o<arguments.length;)e[o]=arguments[o],delete g[e[o]],++o;n.mew(t.name,null,"@mew.ignore",{"!content":!0,"@mew.ignore":e})},this.reset=function(){g={},n.mew(t.name,null,"@mew.reset")},this.restatement=function(){var e=Object.keys(g).map(function(e){return g[e]});this.reset(),this.interest.apply(this,e)},this.reconnect=function(e){this.disconnected&&(this.disconnected=!1,f(),l())},this.disconnect=function(e){0==this.disconnected&&(this.disconnected=!0,this.token=null,this.emit("connection.disconnected"))},this.emit=function(e){if(this.listeners[e]&&this.listeners[e].length){var n=[].slice.call(arguments,1);this.listeners[e].forEach(function(e){try{e.apply(this,n)}catch(e){t.logger.error(e)}})}},this.on=function(e,n){if(!(e&&listenerTypes.indexOf(e)>=0&&$.is(n,Function)))throw new Error("Type not found or callback not function");t.listeners[e].push(n)}};module.exports=Kitty;